---
sidebar-position: 3
title: è®°è´¦é¡¹ç›®æ€»ç»“
date: 2023-12-08
authors: gsemir
tags: [Golang, Gin, sqlc, cobra, viper, swaggo, gomail, postgresql]
---

> **Why Golang**
>
> æ¨èå‰ç«¯å¼€å‘å­¦ä¹  Golang çš„åŸå› ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š
>
> 1. **é«˜æ€§èƒ½**ï¼šGolang æ˜¯ä¸€ç§ç¼–è¯‘å‹è¯­è¨€ï¼Œå…·æœ‰è¾ƒå¿«çš„æ‰§è¡Œé€Ÿåº¦å’Œè¾ƒä½çš„å†…å­˜å ç”¨ã€‚ä¸ Node.js ç­‰è§£é‡Šå‹è¯­è¨€ç›¸æ¯”ï¼ŒGo åœ¨å¤„ç†é«˜å¹¶å‘å’Œ I/O å¯†é›†å‹ä»»åŠ¡æ—¶è¡¨ç°æ›´ä¼˜ï¼Œé€‚åˆæ„å»ºé«˜æ€§èƒ½çš„åç«¯æœåŠ¡ã€‚ä¾‹å¦‚ esbuildï¼Œdocker
> 2. **ç®€æ´çš„è¯­æ³•**ï¼šGo çš„è¯­æ³•ç›¸å¯¹ç®€å•ï¼Œæ˜“äºå­¦ä¹ å’Œä½¿ç”¨ã€‚å¯¹äºå·²ç»ç†Ÿæ‚‰ JavaScript çš„å‰ç«¯å¼€å‘è€…æ¥è¯´ï¼ŒGo çš„è¯­æ³•ç»“æ„å’ŒåŸºæœ¬æ¦‚å¿µï¼ˆå¦‚å‡½æ•°ã€ç»“æ„ä½“ç­‰ï¼‰å®¹æ˜“ä¸Šæ‰‹ï¼Œèƒ½å¤Ÿå¿«é€Ÿé€‚åº”ã€‚æ²¡æœ‰ä¼ ç»Ÿé¢å‘å¯¹è±¡çš„æ„Ÿè§‰ï¼Œå¾ˆåƒ TypeScript
> 3. **å¼ºå¤§çš„å¹¶å‘æ”¯æŒ**ï¼šGo çš„å¹¶å‘æ¨¡å‹åŸºäº goroutines å’Œ channelsï¼Œä½¿å¾—ç¼–å†™å¹¶å‘ç¨‹åºå˜å¾—ç®€å•è€Œé«˜æ•ˆã€‚è¿™å¯¹äºéœ€è¦å¤„ç†å¤šä¸ªè¯·æ±‚çš„ Web åº”ç”¨ç¨‹åºå°¤ä¸ºé‡è¦ï¼Œå¯ä»¥è½»æ¾å®ç°é«˜å¹¶å‘å¤„ç†ã€‚GoRoutines Channels éƒ½æ²¡å­¦ä¹ è¿‡ã€‚
> 4. **ä¸°å¯Œçš„æ ‡å‡†åº“**ï¼šGo çš„æ ‡å‡†åº“æä¾›äº†å¼ºå¤§çš„å·¥å…·é›†ï¼Œå°¤å…¶æ˜¯åœ¨ç½‘ç»œç¼–ç¨‹å’Œ Web å¼€å‘æ–¹é¢ã€‚å¼€å‘è€…å¯ä»¥åˆ©ç”¨å†…ç½®çš„ HTTP åŒ…å¿«é€Ÿæ„å»º Web æœåŠ¡å™¨å’Œå¤„ç†è¯·æ±‚ï¼Œè€Œæ— éœ€ä¾èµ–ç¬¬ä¸‰æ–¹åº“
> 5. **è‰¯å¥½çš„ç¤¾åŒºå’Œç”Ÿæ€**ï¼šè™½ç„¶ Go çš„ç¤¾åŒºç›¸å¯¹è¾ƒå°ï¼Œä½†å…¶ç”Ÿæ€ç³»ç»Ÿæ­£åœ¨ä¸æ–­å‘å±•ï¼Œè®¸å¤šä¼˜ç§€çš„æ¡†æ¶ï¼ˆå¦‚ Ginã€Echoï¼‰å’Œå·¥å…·ï¼ˆå¦‚ Dockerã€Kubernetesï¼‰éƒ½æ˜¯ç”¨ Go å¼€å‘çš„ã€‚å­¦ä¹  Go å¯ä»¥å¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°ç†è§£è¿™äº›å·¥å…·çš„å†…éƒ¨å·¥ä½œåŸç†
>
> **ä½¿ç”¨å¿ƒå¾—**
>
> - è™½ç„¶ Go çš„è¯­æ³•ç®€å•ï¼Œä½†å…¶å¹¶å‘æ¨¡å‹å’Œä¸€äº›ç‰¹æ€§ï¼ˆå¦‚æ¥å£ã€æŒ‡é’ˆï¼‰å¯èƒ½éœ€è¦æ—¶é—´å»ç†è§£ã€‚å»ºè®®é€šè¿‡å®é™…é¡¹ç›®æ¥åŠ æ·±å¯¹è¿™äº›æ¦‚å¿µçš„ç†è§£ã€‚
> - æºç æ˜“è¯»ï¼Œå› ä¸ºå†…ç½®åº“æˆ–ç¬¬ä¸‰æ–¹åº“éƒ½æ˜¯ç”¨ Golang å†™çš„
> - go æ²¡æœ‰ç¹ççš„eslintå’Œprettier ç»Ÿä¸€ä»£ç è§„èŒƒ 
> - go çš„å­¦ä¹ ä¸»è¦é æºç  åŒ…æ‹¬ginæ¡†æ¶ 
> - go ä¸­é¦–å­—æ¯å¤§å†™ä¼šè¢«é»˜è®¤å¯¼å‡º 
> - go ä¸­å˜é‡åä¸€èˆ¬ç”¨ä¸€ä¸ªå­—æ¯ 
> - go ç¨‹åºå‘˜å¾ˆçˆ±ç”¨ç¼©å†™ server => srv æŠŠåŸéŸ³å­—æ¯å»æ‰å°±æ˜¯ç®€å†™ ä¾‹å¦‚ migrate => mgrt
> - go ä¸­æ²¡æœ‰ç»§æ‰¿ä¸å®ç°çš„æ¦‚å¿µï¼Œåªè¦è¿™ä¸ªç»“æ„ä½“æœ‰æ¥å£è¦æ±‚çš„æ–¹æ³•å°±å¯ä»¥ä½œä¸ºè¿™ä¸ªæ¥å£çš„å®ç°

Go ç‰ˆæœ¬ go1.21.0 darwin/arm64

> Go: https://go.dev/
>
> Gin: https://gin-gonic.com/docs/quickstart/
>
> Cobra: https://github.com/spf13/cobra
>
> é€‰å‹: https://star-history.com/ 
>
> Sqlc: [Getting started with PostgreSQL â€” sqlc 1.23.0 documentation](https://docs.sqlc.dev/en/latest/tutorials/getting-started-postgresql.html)
>
> æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²: [PostgreSQL connection strings - ConnectionStrings.com](https://www.connectionstrings.com/postgresql/)
>
> sqlè¯­å¥é€ŸæŸ¥: [PostgreSQL 14 / CREATE TABLE â€” DevDocs](https://devdocs.io/postgresql~14/sql-createtable)
>
> æ•°æ®åº“è¿ç§»: [GitHub - golang-migrate/migrate: Database migrations. CLI and Golang library.](https://github.com/golang-migrate/migrate)
>
> viper: [spf13/viper: Go configuration with fangs (github.com)](https://github.com/spf13/viper)
>
> crypto/rand: [rand package - crypto/rand - Go Packages](https://pkg.go.dev/crypto/rand)
>
> gomail: [go-gomail/gomail: The best way to send emails in Go. (github.com)](https://github.com/go-gomail/gomail)
>
> Mailhog: [mailhog/MailHog: Web and API based SMTP testing (github.com)](https://github.com/mailhog/MailHog)
>
> æ•°æ®æ ¡éªŒ: [validator package - github.com/go-playground/validator/v10 - Go Packages](https://pkg.go.dev/github.com/go-playground/validator/v10#section-readme)](https://pkg.go.dev/github.com/go-playground/validator/v10#ValidationErrors)
>
> jwt: [golang-jwt/jwt: Community maintained clone of https://github.com/dgrijalva/jwt-go](https://github.com/golang-jwt/jwt)
>
> swaggo: [swag/README_zh-CN.md at master Â· swaggo/swag (github.com)](https://github.com/swaggo/swag/blob/master/README_zh-CN.md)

## 1 å¼€å‘å‡†å¤‡

### 1.1 ç¯å¢ƒé…ç½®

#### 1.1.1 macos

å®˜ç½‘ä¸‹è½½å®‰è£…å³å¯
> https://go.dev/dl/

#### 1.1.2 ubuntu 22.04 aarch64

```sh
# ä¸‹è½½å®‰è£…åŒ…
curl -OL https://golang.org/dl/go1.21.0.linux-arm64.tar.gz
# è§£å‹
sudo tar -C /usr/local -xvf go1.21.0.linux-arm64.tar.gz
# ~/.zshrc æ·»åŠ ç¯å¢ƒå˜é‡
export PATH=$PATH:/usr/local/go/bin
# éªŒè¯å®‰è£…
go version
```
#### 1.1.3 é…ç½®ä»£ç†

`go env -w GOPROXY=https://goproxy.cn,direct`

`go env GOPROXY` æŸ¥çœ‹å½“å‰ä»£ç†

#### 1.1.4 å®‰è£… VSCode æ’ä»¶

`aldijav.golangwithdidi`

åŒ…å«ä¸¤æ¬¾æ’ä»¶ï¼š`golang.go`ã€`premparihar.gotestexplorer`

### 1.2 å¸¸è§å‘½ä»¤

`go get -u` è·å–/æ›´æ–°ä¾èµ–åŒ…

`go install` å®‰è£…/ç¼–è¯‘ go ç¨‹åºæˆ–åŒ…ï¼Œä¸€èˆ¬æ˜¯å‘½ä»¤è¡Œç¨‹åºï¼Œé»˜è®¤å®‰è£…è·¯å¾„æ˜¯ $HOME/go/bin

`go mod init account` é¡¹ç›®åˆå§‹åŒ–ï¼Œå°†åˆ›å»ºä¸€ä¸ªåä¸º "account" çš„æ¨¡å—

`go mod tidy` è‡ªåŠ¨å®‰è£…ä¾èµ–åŒ…ï¼Œåˆ é™¤å¤šä½™ä¾èµ–

`go mod vendor` å°†ä¾èµ–åŒ…å¤åˆ¶åˆ° vendor ç›®å½•ä¸­ï¼Œä»¥å®ç°ç‰ˆæœ¬æ§åˆ¶å’Œæ›´ç¨³å®šçš„æ„å»ºã€‚

`go build` ç¼–è¯‘é¡¹ç›®ä¸ºå¯æ‰§è¡Œæ–‡ä»¶

`go build;./account` ç¼–è¯‘å¹¶æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶

`go test ./...` é€’å½’æ‰§è¡Œå…¨éƒ¨æµ‹è¯•ç”¨ä¾‹

### 1.3 åˆå§‹åŒ–é¡¹ç›®

`go mod init account`

`go get -u github.com/gin-gonic/gin`

### 1.4 é¡¹ç›®ä»£ç ç»“æ„

```
â”œâ”€â”€ README.md   ---é¡¹ç›®å¼€å‘æµç¨‹ç¬”è®°
â”œâ”€â”€ account   ---ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶
â”œâ”€â”€ api   ---API è¯·æ±‚å“åº”ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ api.go    ---API è¯·æ±‚å“åº”å…¬å…±ç±»å‹
â”‚   â”œâ”€â”€ item_api.go	
â”‚   â”œâ”€â”€ me_api.go	
â”‚   â”œâ”€â”€ session_api.go	
â”‚   â””â”€â”€ tag_api.go
â”œâ”€â”€ cmd   ---å‘½ä»¤è¡Œåº”ç”¨ç¨‹åºçš„å…¥å£
â”‚   â””â”€â”€ cmd.go
â”œâ”€â”€ config    ---é…ç½®ä¿¡æ¯
â”‚   â”œâ”€â”€ migrations    ---æ•°æ®åº“è¿ç§»æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ 000001_create_users_table.down.sql
â”‚   â”‚   â”œâ”€â”€ ...
â”‚   â”‚   â””â”€â”€ 000006_remove_type_kind.up.sql
â”‚   â”œâ”€â”€ queries   ---åŸç”Ÿ SQL è¯­å¥
â”‚   â”‚   â”œâ”€â”€ items.sql
â”‚   â”‚   â”œâ”€â”€ tags.sql
â”‚   â”‚   â”œâ”€â”€ users.sql
â”‚   â”‚   â””â”€â”€ validation_codes.sql
â”‚   â”œâ”€â”€ schema.sql    ---åŸç”Ÿæ•°æ®åº“è¡¨ç»“æ„å®šä¹‰
â”‚   â”œâ”€â”€ sqlc    ---sqlc è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼Œç”¨äºæ•°æ®åº“äº¤äº’
â”‚   â”‚   â”œâ”€â”€ db.go
â”‚   â”‚   â”œâ”€â”€ items.sql.go
â”‚   â”‚   â”œâ”€â”€ models.go
â”‚   â”‚   â”œâ”€â”€ tags.sql.go
â”‚   â”‚   â”œâ”€â”€ users.sql.go
â”‚   â”‚   â””â”€â”€ validation_codes.sql.go
â”‚   â””â”€â”€ viper.go    ---è¯»å–å¯†é’¥
â”œâ”€â”€ coverage    ---æµ‹è¯•è¦†ç›–ç‡
â”‚   â”œâ”€â”€ cover.out
â”‚   â”œâ”€â”€ coverage.html
â”‚   â”œâ”€â”€ coverage.out
â”‚   â””â”€â”€ index.html
â”œâ”€â”€ docs    ---æ¥å£æ–‡æ¡£
â”‚   â”œâ”€â”€ docs.go
â”‚   â”œâ”€â”€ swagger.json
â”‚   â””â”€â”€ swagger.yaml
â”œâ”€â”€ go.mod    ---å®šä¹‰é¡¹ç›®çš„ä¾èµ–å…³ç³»å’Œç‰ˆæœ¬è¦æ±‚
â”œâ”€â”€ go.sum    ---éªŒè¯ä¸‹è½½çš„æ¨¡å—çš„å®Œæ•´æ€§
â”œâ”€â”€ internal    ---å†…åŒ…å«äº†å„ç§å†…éƒ¨åŠŸèƒ½ï¼Œå¦‚æ§åˆ¶å™¨ã€æ•°æ®åº“ã€ä¸­é—´ä»¶ã€è·¯ç”±ç­‰
â”‚   â”œâ”€â”€ controller    ---æ§åˆ¶å™¨æ–‡ä»¶ï¼Œç”¨äºå¤„ç† HTTP è¯·æ±‚å’Œå“åº”åŠå•å…ƒæµ‹è¯•æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ controller.go   ---Controller æ¥å£å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ item_controller.go
â”‚   â”‚   â”œâ”€â”€ item_controller_test.go
â”‚   â”‚   â”œâ”€â”€ me_controller.go
â”‚   â”‚   â”œâ”€â”€ me_controller_test.go
â”‚   â”‚   â”œâ”€â”€ ping.go
â”‚   â”‚   â”œâ”€â”€ session_controller.go
â”‚   â”‚   â”œâ”€â”€ session_controller_test.go
â”‚   â”‚   â”œâ”€â”€ setup_helper.go   ---åˆå§‹åŒ–æµ‹è¯•åŠæµ‹è¯•å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ tag_controller.go
â”‚   â”‚   â”œâ”€â”€ tag_controller_test.go
â”‚   â”‚   â”œâ”€â”€ validation_codes_controller.go
â”‚   â”‚   â””â”€â”€ validation_codes_controller_test.go
â”‚   â”œâ”€â”€ database    ---æ•°æ®åº“è¿æ¥åŠè¿ç§»ä¿¡æ¯
â”‚   â”‚   â””â”€â”€ database.go
â”‚   â”œâ”€â”€ email   ---å‘é€ç”µå­é‚®ä»¶åŠŸèƒ½
â”‚   â”‚   â””â”€â”€ email.go
â”‚   â”œâ”€â”€ jwt_helper    ---ç”Ÿæˆä¸è§£æ jwt
â”‚   â”‚   â””â”€â”€ jwt_helper.go
â”‚   â”œâ”€â”€ middleware    ---ä¸­é—´ä»¶ï¼ˆèº«ä»½éªŒè¯ã€é”™è¯¯å¤„ç†ï¼‰
â”‚   â”‚   â””â”€â”€ me.go
â”‚   â””â”€â”€ router    ---è·¯ç”±é…ç½®
â”‚       â””â”€â”€ router.go
â”œâ”€â”€ main.go   ---åº”ç”¨ç¨‹åºå…¥å£
â”œâ”€â”€ sqlc.yaml   ---sqlc é…ç½®æ–‡ä»¶
â”œâ”€â”€ test    ---æµ‹è¯•ï¼ˆæš‚æ—¶ä¸ç”¨ï¼‰
â”‚   â”œâ”€â”€ controller_test
â”‚   â”‚   â””â”€â”€ ping_test.go
â”‚   â””â”€â”€ database_test
â”‚       â””â”€â”€ database_test.go
â”œâ”€â”€ viper.config.json.example   ---Viper é…ç½®æ–‡ä»¶ç¤ºä¾‹
â””â”€â”€ web   ---å‰ç«¯æˆ–é™æ€èµ„æºæ–‡ä»¶
```

### 1.5 å‘½ä»¤è¡Œç¨‹åº

åŸºäº `cobra` åˆ›å»ºå‘½ä»¤è¡Œç¨‹åºï¼Œä½¿å¼€å‘å·¥ä½œæµè‡ªåŠ¨åŒ–ï¼Œå®ç°ç±»ä¼¼ rails çš„ `bin/rails db:create` åŠŸèƒ½

- å®‰è£…ä¾èµ–åŒ…ï¼š`go get -u github.com/spf13/cobra@latest`

- ä½¿ç”¨ `cobra.Command` æä¾›çš„ Use å±æ€§æ³¨å†Œå‘½ä»¤å­—ç¬¦ï¼ŒRun å±æ€§æ³¨å†Œå›è°ƒå‡½æ•°

  - é€šè¿‡å›è°ƒå‡½æ•°çš„ `args` å¯ä»¥è·å–å‘½ä»¤è¡Œå‚æ•°

  - å¯ä»¥åœ¨å›è°ƒå‡½æ•°ä¸­è°ƒç”¨å†…ç½® os åº“çš„ `Createã€MkdirAllã€Command` ç­‰æ–¹æ³•ï¼Œåˆ›å»ºæ–‡ä»¶æˆ–è€…æ‰§è¡Œè„šæœ¬

- åˆ›å»º cmd åŒ…ï¼Œç”¨äºæ‰¿æ‹…é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­çš„æ‰€æœ‰å‘½ä»¤è¡Œä»»åŠ¡ï¼Œä¾‹å¦‚å¯åŠ¨æœåŠ¡å™¨ã€åŒæ­¥æ•°æ®åº“ç­‰
  - ä»¥ä¸‹æ˜¯å¼€å¯æœåŠ¡ã€åˆ›å»ºåŒæ­¥æ•°æ®åº“æ–‡ä»¶ä¸ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æ–‡ä»¶çš„ä»£ç ç¤ºä¾‹

```go
// cmd/cmd.go
func Run() {
	rootCmd := &cobra.Command{
		Use: "account",
	}
	srvCmd := &cobra.Command{
		Use: "server",
		Run: func(cmd *cobra.Command, args []string) {
			RunServer()
		},
	}
	dbCmd := &cobra.Command{
		Use: "db",
	}
	mgrCreateCmd := &cobra.Command{
		Use: "migrate:create",
		Run: func(cmd *cobra.Command, args []string) {
			database.MigrateCreate(args[0])
		},
	}
	coverCmd := &cobra.Command{
		Use: "coverage",
		Run: func(cmd *cobra.Command, args []string) {
			// ä½¿ç”¨ os é¢„å…ˆåœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º coverage ç›®å½•
			os.MkdirAll("coverage", os.ModePerm)
			// ä½¿ç”¨ os/exec æ‰§è¡Œå‘½ä»¤è¡Œ
			if err := exec.Command("MailHog").Start(); err != nil {
				log.Println(err)
			}
			if err := exec.Command(
				"go", "test", "-coverprofile=coverage/cover.out", "./...",
			).Run(); err != nil {
				log.Fatalln(err)
			}
			if err := exec.Command(
				"go", "tool", "cover", "-html=coverage/cover.out", "-o", "coverage/index.html",
			).Run(); err != nil {
				log.Fatalln(err)
			}
			// ä½¿ç”¨ gin å¼€å¯æœ¬åœ°æ–‡ä»¶æœåŠ¡
			var port string
			if len(args) > 0 {
				port = args[0]
			} else {
				port = "8888"
			}
			fmt.Println("http://localhost:" + port + "/coverage/index.html")
			if err := http.ListenAndServe(":"+port, http.FileServer(http.Dir("."))); err != nil {
				log.Fatalln(err)
			}
		},
	}
  
	database.Connect()
	defer database.Close()

	rootCmd.AddCommand(srvCmd, dbCmd, coverCmd)
	dbCmd.AddCommand(mgrCreateCmd)

	rootCmd.Execute()
}
```

- ä½¿ç”¨æ—¶æ— éœ€è¾“å…¥æ ¹å‘½ä»¤ï¼Œåªéœ€ä»ç¬¬äºŒçº§å‘½ä»¤å¼€å§‹è¾“å…¥å³å¯ï¼Œä¾‹å¦‚ `go build;./account db migrate:create`

### 1.6 ç¨‹åºå…¥å£


- å› ä¸ºæœ‰ cobra å‘½ä»¤è¡Œç¨‹åºï¼Œå› æ­¤ main.go æ–‡ä»¶ä¸»è¦åšä¸¤ä»¶äº‹å°±å¯ä»¥äº†ï¼šè¯»å–æœ¬åœ°å¯†é’¥ä¸åˆå§‹åŒ–å‘½ä»¤è¡Œç¨‹åº


  - ```go
    // main.go
    func main() {
    	viper_config.LoadViperConfig()
    	cmd.Run()
    }
    ```

- å‘½ä»¤è¡Œç¨‹åºé™¤äº†æ³¨å†Œå‘½ä»¤å¤–ï¼Œè¿˜è¦è¿›è¡Œæ•°æ®åº“çš„è¿æ¥

- æœåŠ¡å¯åŠ¨æ—¶ï¼Œé¦–å…ˆåˆå§‹åŒ– gin å¼•æ“å®ä¾‹ï¼Œæ³¨å†Œä¸­é—´ä»¶å’Œè·¯ç”±ï¼Œå†è°ƒç”¨ Run æ–¹æ³•å¯åŠ¨æœåŠ¡å³å¯

> ç”±äº gin.Default() ä¼šé»˜è®¤åŠ è½½ Logger ä¸­é—´ä»¶ï¼Œå¯¼è‡´æµ‹è¯•æ§åˆ¶å°è¾“å‡ºä¿¡æ¯è¿‡å¤šï¼Œä¸æ–¹ä¾¿ debug
>
> å› æ­¤æˆ‘ä»¬ç…§æŠ„æºç çš„æµç¨‹ï¼Œä¸ä½¿ç”¨ Logger å³å¯ï¼ŒåŒæ—¶å°† gin æ¡†æ¶é»˜è®¤çš„ debug æ¨¡å¼æ”¹ä¸º release æ¨¡å¼ï¼ˆæºç æœ‰ç›¸å…³æç¤ºï¼‰
>
> è¿™æ ·å°±å¯ä»¥å¤§å¹…å‡å°‘æ§åˆ¶å°è¾“å‡ºæ— ç”¨çš„ log


```go
// cmd/cmd.go
func RunServer() {
  // åˆ›å»ºè·¯ç”±
  gin.SetMode(gin.ReleaseMode)
  r := gin.New()
  r.Use(gin.Recovery())
  // åº”ç”¨ä¸­é—´ä»¶: æ³¨æ„ä¸­é—´ä»¶çš„å£°æ˜ä½ç½®ï¼Œè¦åœ¨æ‰€æœ‰è·¯ç”±ä¹‹å‰Use!
  r.Use(middleware.Me([]string{"/swagger", "/api/v1/session", "/api/v1/validation_codes", "/ping"}))
  // æ³¨å†Œè·¯ç”±
  rg := r.Group("/api")
  for _, ctrl := range loadControllers() {
    ctrl.RegisterRoutes(rg)
  }
  // æ–‡æ¡£è·¯ç”±åŠé…ç½®
  docs.SwaggerInfo.Version = "1.0"
  r.GET("/swagger/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))
  r.GET("/ping", controller.Ping)

  r.Run(":8080")
}
```


### 1.7 æ–­ç‚¹è°ƒè¯•

- å®‰è£… go æ–­ç‚¹è°ƒè¯•å‘½ä»¤è¡Œç¨‹åºï¼š`go install -v github.com/go-delve/delve/cmd/dlv@latest`
- åœ¨å•å…ƒæµ‹è¯•ä¸­ç‚¹ debug test è¿›å…¥æ–­ç‚¹è°ƒè¯•ï¼Œï¼ˆæ­¤æ—¶ VSCode ä¹Ÿä¼šè‡ªåŠ¨å®‰è£…æ­¤ç¨‹åºï¼‰

- é…ç½®ï¼š

```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Go Debug",
      "type": "go",
      "request": "launch",
      "mode": "auto",
      // "program": "${fileDirname}"
      "program": "${workspaceFolder}",
      "args": [
        "server"
      ]
    }
  ]
}
```


## 2 Database

### 2.1 æ•°æ®åº“é€‰å‹

#### 2.1.1 database/sql

> [sql package - database/sql - Go Packages](https://pkg.go.dev/database/sql)
> ä½¿ç”¨ç¤ºä¾‹: [feat: crud via sqlc Â· GSemir0418/account-backend-go@ac43545 Â· GitHub](https://github.com/GSemir0418/account-backend-go/commit/ac43545945ca2d5a8eee5e879924206b887c42a3)
- ä¼˜ç‚¹ï¼š

1. å®˜æ–¹åŒ…ï¼Œå¾—åˆ° Go ç¤¾åŒºçš„æ”¯æŒä¸ç»´æŠ¤
2. è½»é‡çº§ï¼Œä¸ä¼šå¼•å…¥é¢å¤–çš„ä¾èµ–
3. è‰¯å¥½çš„è·¨æ•°æ®å…¼å®¹æ€§
- ç¼ºç‚¹ï¼š
1. ç¼ºå°‘é«˜çº§åŠŸèƒ½ï¼Œå¦‚æŸ¥è¯¢æ„å»ºå™¨ã€å…³è”ã€è¿ç§»ç­‰
2. æ‰‹åŠ¨ç®¡ç† sql è¯­å¥ï¼Œæ˜“å‡ºé”™ä¸”éš¾ä»¥ç»´æŠ¤

#### 2.1.2 gorm
> [GORM Guides | GORM - The fantastic ORM library for Golang, aims to be developer friendly.](https://gorm.io/docs/)
>
> ä½¿ç”¨ç¤ºä¾‹: [feat: crud via gorm Â· GSemir0418/account-backend-go@ee36037 Â· GitHub](https://github.com/GSemir0418/account-backend-go/commit/ee36037698497b67909c94d60498f213809e8b19)

- ä¼˜ç‚¹ï¼š
1. æä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¦‚æŸ¥è¯¢æ„å»ºå™¨ã€å…³è”ã€è¿ç§»ç­‰
2. æ”¯æŒè‡ªåŠ¨è¿ç§»æ•°æ®åº“
3. æä¾›äº†æ›´é«˜çº§çš„æŸ¥è¯¢æ¥å£ï¼Œå‡å°‘äº†æ‰‹åŠ¨ç¼–å†™ sql è¯­å¥çš„éœ€æ±‚
4. è‰¯å¥½çš„æ–‡æ¡£å’Œç¤¾åŒºæ”¯æŒ
- ç¼ºç‚¹ï¼š
1. ä¾èµ–æ›´å¤šçš„å¤–éƒ¨åº“ï¼Œå¯èƒ½å¯¼è‡´é¡¹ç›®è‡ƒè‚¿
2. æŠ½è±¡å±‚å¯èƒ½å¯¼è‡´æ€§èƒ½æŸå¤±
3. å¯èƒ½éœ€è¦æ›´å¤šçš„å­¦ä¹ æˆæœ¬

#### 2.1.3 sqlcâœ…
> [Getting started with PostgreSQL â€” sqlc 1.23.0 documentation](https://docs.sqlc.dev/en/latest/tutorials/getting-started-postgresql.html)
- ä¼˜ç‚¹ï¼š
1. å°† sql æŸ¥è¯¢è½¬æ¢ä¸ºç±»å‹å®‰å…¨çš„ go ä»£ç ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå®‰å…¨æ€§
2. é€šè¿‡ç”Ÿæˆä»£ç ï¼Œå¯ä»¥å‡å°‘æ‰‹åŠ¨ç¼–å†™ sql è¯­å¥çš„é”™è¯¯
3. æ”¯æŒ postgresql å’Œ mysql
4. è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼Œæ˜“ä¸ç»´æŠ¤
- ç¼ºç‚¹ï¼š
1. æ²¡æœ‰æ”¯æŒæ‰€æœ‰ç±»å‹çš„æ•°æ®åº“
2. å¯èƒ½éœ€è¦å¯¹ sql è¯­å¥è¿›è¡Œè°ƒæ•´ä»¥ç”Ÿæˆæ­£ç¡®çš„ go ä»£ç 
3. è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç å¯èƒ½éš¾ä»¥ç†è§£å’Œè°ƒè¯•
4. åŠŸèƒ½æœ‰é™ï¼Œç¼ºå°‘ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œå¦‚å…³è”ã€è¿ç§»ç­‰

### 2.2 è¿æ¥æ•°æ®åº“

> æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼ˆä¸æœ¬é¡¹ç›®æ— å…³ï¼‰ï¼š[PostgreSQL connection strings - ConnectionStrings.com](https://www.connectionstrings.com/postgresql/)

ä½¿ç”¨å®˜æ–¹åŒ… database/sql è¿æ¥æ•°æ®åº“ã€‚åˆ›å»º database åŒ…ï¼Œå¯¹å¤–æä¾›æ•°æ®åº“çš„è¿ç§»ä¸è¿æ¥ç­‰æ–¹æ³•

`database/sql` åŒ…å·²ç»å†…ç½®äº†å¯¹ PostgreSQL æ•°æ®åº“çš„æ”¯æŒï¼Œå› æ­¤æ— éœ€æ˜¾å¼å¼•å…¥ `"github.com/lib/pq"` åŒ…æ¥è¿æ¥ PostgreSQL æ•°æ®åº“

```go
// database/database.go
// å£°æ˜å…¨å±€å˜é‡ DBï¼Œå­˜å‚¨æ•°æ®åº“å®ä¾‹ï¼Œä¿è¯æœåŠ¡åªå­˜åœ¨ä¸€ä¸ª DB å®ä¾‹
var DB *sql.DB

const (
	host     = "localhost"
	port     = 5432
	user     = "gsemir"
	password = "gsemir"
	dbname   = "go_account_dev"
)

func Connect() {
	// é˜²æ­¢é‡å¤è¿æ¥
	if DB != nil {
		return
	}
  // å£°æ˜è¿æ¥å­—ç¬¦ä¸²
	dsn := fmt.Sprintf("host=%s port=%d user=%s password=%s dbname=%s sslmode=disable", host, port, user, password, dbname)
	db, err := sql.Open("postgres", dsn)
	if err != nil {
		log.Fatalln(err)
	}
	DB = db
	err = db.Ping()
	if err != nil {
		log.Fatal(err)
	}
}
```

### 2.3 æ•°æ®åº“è¿ç§»

é€‰æ‹© `golang-migrate/migrate` åº“ä½œä¸ºæ•°æ®åº“è¿ç§»å·¥å…·

> [GitHub - golang-migrate/migrate: Database migrations. CLI and Golang library.](https://github.com/golang-migrate/migrate)

#### 2.3.1 å®‰è£…

`go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest`

#### 2.3.2 åˆ›å»ºè¿ç§»æ–‡ä»¶

åœ¨ config ä¸­åˆ›å»º migrations ç›®å½•

`migrate create -ext sql -dir config/migrations -seq create_users_table`

æŒ‡å®šæ•°æ®åº“è¿ç§»æ–‡ä»¶çš„æ‰©å±•åä¸º sqlï¼Œç›®å½•ä¸º config/migrationsï¼Œåç§°ä¸º create_users_table

è¯¥å‘½ä»¤ä¼šåœ¨æŒ‡å®šç›®å½•ä¸‹åˆ›å»ºè¿ç§»å’Œå›é€€æ–‡ä»¶ï¼Œå…¶å†…å®¹éœ€è¦è‡ªè¡Œç¼–å†™ï¼Œä¾‹å¦‚ `CREATE TABLE => DROP TABLE`ï¼Œ`ALTER TABLE users ADD COLUMN => ALTER TABLE users DROP COLUMN` ç­‰

#### 2.3.3 æ³¨æ„äº‹é¡¹

- å½“è¿ç§»çš„å†…å®¹è¿‡å¤šæˆ–è€…è¾ƒå¤æ‚æ—¶ï¼Œè¦ä½¿ç”¨äº‹åŠ¡è¿›è¡Œè¿ç§»ä¸å›é€€

```sql
# 000006_remove_type_kind.up.sql
BEGIN;
ALTER TABLE items
ALTER COLUMN kind TYPE VARCHAR(100),
ALTER COLUMN kind SET DEFAULT 'expenses';

ALTER TABLE tags
ALTER COLUMN kind TYPE VARCHAR(100),
ALTER COLUMN kind SET DEFAULT 'expenses';
DROP TYPE kind;
COMMIT;
# 000006_remove_type_kind.down.sql
BEGIN;
CREATE TYPE kind AS ENUM ('expenses', 'in_come', '');
ALTER TABLE items DROP COLUMN kind;
ALTER TABLE items ADD COLUMN kind kind NOT NULL DEFAULT 'expenses';
ALTER TABLE tags DROP COLUMN kind;
ALTER TABLE tags ADD COLUMN kind kind NOT NULL DEFAULT 'expenses';
COMMIT;
```

- å¦‚æœè¿ç§»ï¼ˆupï¼‰å‡ºé”™äº†ï¼Œä¸”ä¸èƒ½ä½¿ç”¨å›æ»šï¼ˆdownï¼‰æ¥è§£å†³ï¼Œé‚£ä¹ˆæ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“çš„ `schema_migrations` è¡¨æ ¼ï¼Œå°†æ•°æ®è®¾ç½®ä¸ºä¸Šæ¬¡çš„ç‰ˆæœ¬ï¼Œ`dirty` å­—æ®µè®¾ä¸º `false`:

  `update schema_migrations set version=3,dirty=false;`

  ç„¶åæ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“æˆ–è¿ç§»æ–‡ä»¶é”™è¯¯ï¼Œé‡æ–°æ‰§è¡Œè¿ç§»å³å¯

#### 2.3.4 è¿è¡Œè¿ç§»æ–‡ä»¶

`migrate -database "postgres://gsemir:gsemir@localhost:5432/go_account_dev?sslmode=disable" \
-source "file://$(pwd)/config/migrations" up`

#### 2.3.5 å°è£… cmd

ä½¿ç”¨ cobra å°è£…æ•°æ®åº“åŒæ­¥ã€å›é€€ç­‰å‘½ä»¤ã€‚æ³¨æ„å¼•å…¥ä¾èµ–çš„å½¢å¼

```go
// database/database.go
package database

import (
	"database/sql"
	"fmt"
	"log"
	"os/exec"

	"github.com/golang-migrate/migrate/v4"
	_ "github.com/golang-migrate/migrate/v4/database/postgres"
	_ "github.com/golang-migrate/migrate/v4/source/file"
)
func MigrateCreate(filename string) {
	cmd := exec.Command("migrate", "create", "-ext", "sql", "-dir", "config/migrations", "-seq", filename)
	err := cmd.Run()
	if err != nil {
		log.Fatalln(err)
	}
}
func MigrateUp() {
	dir, err := os.Getwd()
	if err != nil {
		log.Fatalln(err)
	}
	m, err := migrate.New(
		fmt.Sprintf("file://%s/config/migrations", dir),
		fmt.Sprintf("postgres://%s:%s@%s:%d/%s?sslmode=disable",
			user, password, host, port, dbname,
		),
	)
	if err != nil {
		log.Fatalln(err)
	}
	err = m.Up() // ä¼šç›´æ¥åŒæ­¥æ‰€æœ‰æ›´æ–°
  // MigrateDown æ–¹æ³•æ˜¯è°ƒç”¨ m.Step(-1)ï¼Œé»˜è®¤åªå›é€€ä¸€æ¬¡
	if err != nil {
		log.Fatalln(err)
	}
}

// cmd/cmd.go
mgrCreateCmd := &cobra.Command{
  Use: "migrate:create",
  Run: func(cmd *cobra.Command, args []string) {
    database.MigrateCreate(args[0])
  },
}
```

- åˆ›å»ºè¿ç§»æ–‡ä»¶å‘½ä»¤ `go build; ./account db migrate:create add_email_to_users `
- è¿è¡Œè¿ç§»æ–‡ä»¶å‘½ä»¤ `go build; ./account db migrate:up`
- å›æ»šè¿ç§»å‘½ä»¤ `go build; ./account db migrate:down`

### 2.4 sqlc çš„ä½¿ç”¨


sqlc æ˜¯ç¼–è¯‘å™¨ï¼Œå¯ä»¥å°† sql è¯­å¥ç¼–è¯‘ä¸º Go çš„ struct å’Œ funcï¼Œä»¥ä¿è¯ç±»å‹å®‰å…¨

1. å®‰è£…å‘½ä»¤è¡Œç¨‹åº

`brew install sqlc` æˆ– `go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest`

2. é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºé…ç½®æ–‡ä»¶ sqlc.yaml

```yaml
version: "2"
sql:
  - engine: "postgresql"
    queries: "config/queries" # sql è¯­å¥ç›®å½•
    schema: "config/schema.sql" # è¡¨ç»“æ„
    gen: 
      go:
        emit_json_tags: true #è‡ªåŠ¨æ·»åŠ  json æ ‡ç­¾
        json_tags_case_style: snake # struct çš„ json è¾“å‡ºæ ¼å¼ä¸º snake(snake pascal camel)
        package: "queries" # ç”Ÿæˆçš„åŒ…å
        out: "config/sqlc" # è¾“å‡ºç›®å½•
```

3. åœ¨ config/schema.sql ä¸­å¤åˆ¶ migration æ–‡ä»¶ä¸­çš„å»ºè¡¨è¯­å¥å³å¯
4. config/queries å†™ sql æŸ¥è¯¢è¯­å¥

```sql
# config/queries/items.sql
-- name: CreateItem :one
INSERT INTO items (
  user_id,
  amount,
  kind,
  happened_at,
  tag_ids
) VALUES (
  $1,
  $2,
  $3,
  $4,
  $5
)
RETURNING *;

-- name: ListItems :many
SELECT * FROM items
ORDER BY happened_at DESC
OFFSET $1
LIMIT $2;

-- name: CountItems :one
SELECT count(*) FROM items;

-- name: DeleteAllItems :exec
DELETE FROM items;

-- name: ListItemsByHappenedAtAndKind :many
SELECT * from items
WHERE happened_at >= @happened_after
AND happened_at < @happened_before
AND kind = @kind
AND user_id = @user_id
ORDER BY happened_at DESC;
```

å‚æ•°å¯ä»¥ä½¿ç”¨ `$1` å ä½ç¬¦ï¼Œä¹Ÿå¯ä»¥æ˜¾ç¤ºæŒ‡å®šå‚æ•° `@user_id`ï¼ˆä¸èƒ½ä¸ sql ä¸­çš„å…³é”®å­—å†²çªï¼‰

5. æ‰§è¡Œ `sqlc generate` ç”Ÿæˆå¯¹åº”çš„ Go ä»£ç 

## 3 å•å…ƒæµ‹è¯•

### 3.1 åˆå§‹åŒ–

æµ‹è¯•å‰ï¼Œå°†å…¬å…±åˆå§‹åŒ–è¿‡ç¨‹æŠ½ç¦»å‡ºæ¥ï¼Œå‡å°‘ä»£ç å†—ä½™

è¿™é‡Œæˆ‘ä»¬å°†åˆå§‹åŒ–æœåŠ¡ã€æ³¨å†Œä¸­é—´ä»¶ã€è¿æ¥æ•°æ®åº“ç­‰æ“ä½œæŠ½ç¦»è‡³ internal/controller/setup_helper.go ä¸­

å¹¶æä¾›åŒ…å†…å…¨å±€å˜é‡ r ï¼ˆginæœåŠ¡å®ä¾‹ï¼‰ã€qï¼ˆæ•°æ®åº“æŸ¥è¯¢å®ä¾‹ï¼‰ã€cï¼ˆé»˜è®¤ä¸Šä¸‹æ–‡ï¼‰ä¾›å•å…ƒæµ‹è¯•ä½¿ç”¨

```go
var (
	r *gin.Engine
	q *queries.Queries
	c context.Context
)

func setUpTestCase(t *testing.T) func(t *testing.T) {
	// è¯»å– viper é…ç½®
	viper_config.LoadViperConfig()
	// è¿æ¥æ•°æ®åº“
	database.Connect()
	q = database.NewQuery()
	// åˆå§‹åŒ– gin æœåŠ¡å™¨
	gin.SetMode(gin.ReleaseMode)
	r = gin.New()
  // åº”ç”¨ä¸­é—´ä»¶
	r.Use(gin.Recovery())
	r.Use(middleware.Me([]string{"/swagger", "/api/v1/session", "/api/v1/validation_codes", "/ping"}))
	// é»˜è®¤ä¸Šä¸‹æ–‡
	c = context.Background()
	// æ¸…ç©º User è¡¨
	if err := q.DeleteAllUsers(c); err != nil {
		t.Fatal(err)
	}
	// æ¸…ç©º Items è¡¨
	if err := q.DeleteAllItems(c); err != nil {
		t.Fatal(err)
	}
	// æ¸…ç©º Tags è¡¨
	if err := q.DeleteAllTags(c); err != nil {
		t.Fatal(err)
	}
	// è¿”å›æ¸…ç†å‡½æ•°ï¼Œå¼€å‘è€…è‡ªè¡Œé€‰æ‹©æ‰§è¡Œ
	return func(t *testing.T) {
		database.Close()
	}
}
```

ä¸€äº›æµ‹è¯•ä¸­é‡å¤çš„é€»è¾‘ä¹Ÿå¯ä»¥æŠ½ç¦»åˆ°è¿™é‡Œï¼Œä¾‹å¦‚ç”Ÿæˆ jwt æ„å»ºæƒé™è¯·æ±‚å¤´çš„é€»è¾‘

```go
func logIn(t *testing.T, userID int32, req *http.Request) {
	jwtString, _ := jwt_helper.GenerateJWT(int(userID))
  // Go è¯­è¨€ä¼šè‡ªåŠ¨è§£å¼•ç”¨ç»“æ„ä½“æŒ‡é’ˆå¹¶è®¿é—®ç»“æ„ä½“å¯¹è±¡çš„å­—æ®µï¼Œå› æ­¤å¯ä»¥ç›´æ¥è®¿é—® req.Header
	req.Header = http.Header{
		"Authorization": []string{"Bearer " + jwtString},
	}
}
```

### 3.2 å•å…ƒæµ‹è¯•

#### 3.2.1 æµ‹è¯•æµç¨‹

1. åˆå§‹åŒ–
2. æ³¨å†Œè·¯ç”±
3. åˆå§‹åŒ– ``httptest.NewRecorder()`ï¼Œç”¨äºè®°å½•å“åº”æ•°æ®ï¼›
4. æ„é€ è¯·æ±‚ `http.NewRequest()`ï¼›åˆ›å»ºç”¨æˆ·ï¼Œæ·»åŠ è¯·æ±‚å¤´æƒé™å­—æ®µ
5. `r.ServeHTTP(w, req)` å‘èµ·è¯·æ±‚
6. `assert` æ–­è¨€å“åº”çŠ¶æ€ç åŠå“åº”ä½“æ•°æ®

#### 3.2.2 ä»£ç ç¤ºä¾‹

ä»¥ create item api ä¸ºä¾‹

```go
func TestItemControllerWithUser(t *testing.T) {
  // åˆå§‹åŒ–
	cleanup := setUpTestCase(t)
	defer cleanup(t)
  // æ³¨å†Œè·¯ç”±
	ic := ItemController{}
	ic.RegisterRoutes(r.Group("/api"))
  // åˆå§‹åŒ– w
	w := httptest.NewRecorder()
	// æ„é€ è¯·æ±‚
	reqBody := gin.H{
		"amount":      100,
		"kind":        "in_come",
		"happened_at": time.Now(),
		"tag_ids":     []int32{1, 2, 3},
	}
	bytes, _ := json.Marshal(reqBody)
	req, _ := http.NewRequest(
		"POST",
		"/api/v1/items",
		strings.NewReader(string(bytes)),
	)
  // ç™»å½•
	u, _ := q.CreateUser(c, "1@qq.com")
	logIn(t, u.ID, req)
	// å‘èµ·è¯·æ±‚
	r.ServeHTTP(w, req)
	assert.Equal(t, 200, w.Code)
  // å¤„ç†å“åº”ä½“
	var resBody api.CreateItemResponse
	json.Unmarshal(w.Body.Bytes(), &resBody)
  // æ–­è¨€
	assert.Equal(t, u.ID, resBody.Resource.UserID)
}
```

#### 3.2.3 æ³¨æ„äº‹é¡¹

1. url å‚æ•°æ„é€ 

æŸ¥è¯¢å­—ç¬¦ä¸²ä¸ url çš„æ‹¼æ¥æœ‰ä¸¤ç§å¸¸ç”¨æ–¹æ¡ˆ

```go
// æ–¹æ¡ˆä¸€ ç›´æ¥æ‹¼
req, _ := http.NewRequest(
  "GET",
  "/api/v1/items/balance?happened_after="+url.QueryEscape("2023-09-29T00:00:00+0800")+
  "&happened_before="+url.QueryEscape("2023-10-01T00:00:00+0800"),
  nil,
)


// æ–¹æ¡ˆäºŒ å…ˆæ„é€ ï¼Œç»Ÿä¸€Encodeï¼Œå†æ‹¼æ¥
qs := url.Values{
  "happened_after":  []string{"2023-09-01T00:00:00+08:00"},
  "happened_before": []string{"2023-09-03T00:00:00+08:00"},
  "kind":            []string{"expenses"},
  "group_by":        []string{"tag_id"},
}.Encode()
req, _ := http.NewRequest(
  "GET",
  "/api/v1/items/summary?"+qs,
  nil,
)
```

å…¶ä¸­ï¼Œ`url.QueryEscape()` å°†å­—ç¬¦ä¸²ä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼ˆç©ºæ ¼ã€åŠ å·ã€ç­‰å·ã€ä¸å·ã€é—®å·ç­‰ï¼‰è½¬æ¢ä¸ºç™¾åˆ†æ¯”ç¼–ç å½¢å¼ï¼Œä»¥ä¾¿å®‰å…¨åœ°åŒ…å«åœ¨URLä¸­ï¼›`url.Values` æ˜¯ä¸€ä¸ªå­˜å‚¨URLæŸ¥è¯¢å‚æ•°çš„ç±»å‹ï¼Œå®ƒå¯ä»¥ç”¨äºæ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²ã€‚`Encode` æ–¹æ³•å°† `url.Values` ç¼–ç ä¸ºæŸ¥è¯¢å­—ç¬¦ä¸²å½¢å¼ï¼›

ç±»ä¼¼ JavaScripts ä¸­çš„ `encodeURIComponent` æˆ–è€…æµè§ˆå™¨ç¯å¢ƒä¸‹çš„ `URLSearchParams` ç±»

2. è¯·æ±‚ä½“å¤„ç†

åœ¨ Gin æ¡†æ¶ä¸­ï¼Œ`gin.H` æ˜¯ä¸€ä¸ªç”¨äºæ„å»º JSON æ•°æ®çš„ç®€ä¾¿æ–¹å¼çš„ç±»å‹ï¼›

`json.Marshal` å‡½æ•°ç”¨äºå°† Go ä¸­çš„æ•°æ®ç»“æ„è½¬æ¢ä¸º JSON æ ¼å¼çš„å­—èŠ‚åˆ‡ç‰‡ï¼›

```go
reqBody := api.CreateTagRequest{
  Name: "test",
  Kind: "in_come",
  Sign: "ğŸ˜ˆ",
}
// reqBody := gin.H{
// 	"name": "test",
// 	"kind": "in_come",
// 	"sign": "ğŸ˜ˆ",
// }
bytes, _ := json.Marshal(reqBody)
req, _ := http.NewRequest(
  "POST",
  "/api/v1/tags",
  strings.NewReader(string(bytes)),
)
```

3. å“åº”ä½“å¤„ç†

ä½¿ç”¨ `json.Unmarshal` å‡½æ•°å°† JSON æ ¼å¼çš„æ•°æ®è§£æä¸º Go ä¸­çš„æ•°æ®ç»“æ„ã€‚å®ƒæ¥å—ä¸€ä¸ª `[]byte` åˆ‡ç‰‡å’Œä¸€ä¸ªæŒ‡å‘ç›®æ ‡ç±»å‹çš„æŒ‡é’ˆï¼Œå¹¶å°† JSON æ•°æ®è§£æåˆ°ç›®æ ‡ç±»å‹ä¸­ã€‚

```go
body := w.Body.String()
var j api.GetSummaryByTagIDResponse
json.Unmarshal([]byte(body), &j)
assert.Equal(t, 60000, j.Total)
```

4. æ—¶é—´æ ¼å¼å¤„ç†

TODO

5. å¸¸ç”¨æ–­è¨€
   1. `assert.Equal(t, expected, actual)` æ–­è¨€æ˜¯å¦ç›¸ç­‰ï¼›
   2. `assert.True(t, someCondition)` å’Œ `assert.False` åˆ†åˆ«ç”¨äºæ–­è¨€è¡¨è¾¾å¼æ˜¯å¦ä¸ºçœŸæˆ–ä¸ºå‡ï¼›
   3. `assert.NotNil(t, someValue)` å’Œ `assert.Nil` åˆ†åˆ«ç”¨äºæ–­è¨€å€¼æ˜¯å¦éç©ºæˆ–ä¸ºç©ºï¼›
   4. `assert.Contains(t, collection, element)` ç”¨äºæ–­è¨€ä¸€ä¸ªé›†åˆï¼ˆæ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ç­‰ï¼‰ä¸­æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ 
   5. `assert.Empty(t, Collection)` å’Œ `assert.NotEmpty` åˆ†åˆ«ç”¨äºæ–­è¨€é›†åˆæ˜¯å¦ä¸ºç©ºæˆ–éç©ºã€‚


### 3.3 å±•ç¤ºæµ‹è¯•è¦†ç›–ç‡

- å•æµ‹æ–‡ä»¶ä¸æ§åˆ¶å™¨æ–‡ä»¶é¡»åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ²¡æœ‰è®¾ç½®ç‹¬ç«‹ test ç›®å½•çš„åŸå› 

å±•ç¤ºæµ‹è¯•è¦†ç›–ç‡

`go test -coverprofile=coverage/coverage.out ./...`

ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡html

`go tool cover -html=coverage/coverage.out -o coverage/coverage.html`

- å°†æµ‹è¯•ç»“æœå¯è§†åŒ–ï¼Œæ–¹ä¾¿è¡¥å……æµ‹è¯•ç”¨ä¾‹

### 3.4 ä¼˜åŒ–å·¥ä½œæµ

- ç›®å‰æˆ‘ä»¬çš„TDDæµç¨‹ä¸ºï¼š

å†™æµ‹è¯• => å†™ä»£ç  => å¼€å¯ MailHog => æ‰§è¡Œæµ‹è¯• => ç”Ÿæˆè¦†ç›–ç‡ => ç”Ÿæˆè¦†ç›–ç‡ html => å¼€å¯httpæœåŠ¡æ‰“å¼€html => æ ¹æ®è¦†ç›–ç‡è°ƒæ•´æµ‹è¯•ä»£ç 

å¯ä»¥å°†â€å¼€å¯MailHogâ€œåˆ°â€å¼€å¯httpæœåŠ¡æ‰“å¼€htmlâ€œçš„è¿‡ç¨‹æŠ½ç¦»ä¸ºä¸€ä¸ªæ§åˆ¶å°å‘½ä»¤ `coverage`ï¼Œå…·ä½“ä»£ç è¯¦è§ 1.5 å‘½ä»¤è¡Œç¨‹åºã€‚

- å…·ä½“å®ç°

`os/exec` åŒ…æä¾›äº†è¿è¡Œç³»ç»Ÿè„šæœ¬çš„åŠŸèƒ½ï¼›ä½¿ç”¨ginæ¡†æ¶æä¾›çš„ `http.FileSever` æ–¹æ³•å¼€å¯æœ¬åœ°æ–‡ä»¶æœåŠ¡

>  `exec.Command(...).Start()` å’Œ `exec.Command(...).Run()` çš„åŒºåˆ«ï¼š
>
> å‰è€…ä¼šæ‰§è¡Œè¿™æ¡å‘½ä»¤ï¼Œä½†ä¸ä¼šç­‰å¾…å…¶ç»“æŸï¼Œç›´æ¥æ‰§è¡Œä¸‹ä¸€è¡Œä»£ç 

## 4 å¯†é’¥ç®¡ç†

### 4.1 ä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œç®¡ç†

å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„ç¯å¢ƒå˜é‡çš„æ–¹å¼è¿›è¡Œå¯†é’¥ç®¡ç†ï¼Œå³åœ¨ .zshrc ä¸­ `export EMAIL_SMTP_PWD='xxxxxx'` ï¼Œåœ¨é¡¹ç›®ä¸­é€šè¿‡ `os.Getenv("EMAIL_SMTP_PWD")` è·å–åˆ°å¯†é’¥å³å¯

ä½†å½“ååŒå¼€å‘æ—¶è®¾ç½®ç¯å¢ƒå˜é‡ä¼šå¾ˆç¹çï¼Œä¸”æ•°æ®ç±»å‹ä»…æ”¯æŒå­—ç¬¦ä¸²ï¼Œéœ€è¦æ‰‹åŠ¨è½¬æ¢

### 4.2 viper

ä½¿ç”¨ viper è¿›è¡Œé¡¹ç›®çš„å¯†é’¥ç®¡ç†

- å®‰è£…ï¼š`go get github.com/spf13/viper`

- é…ç½®æ–‡ä»¶ï¼š`viper.config.json`ï¼Œå¯ä»¥æ”¾åœ¨æœåŠ¡å™¨æ ¹ç›®å½•ä¸‹ï¼ˆæ–¹ä¾¿æµ‹è¯•ç¯å¢ƒè¯»å–é…ç½®ä¿¡æ¯ï¼‰

é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `viper.config.json.example` ä»…ä¾›å‚è€ƒ

é’ˆå¯¹æ­¤é¡¹ç›®ï¼Œéœ€è¦ç®¡ç†çš„å¯†é’¥ä¸»è¦æ˜¯ jwt åŠ å¯†å¯†é’¥ä»¥åŠé‚®ç®±æˆæƒç 

å…¶ä¸­é‚®ç®±æˆæƒç ç›´æ¥ä»¥å­—é¢é‡å½¢å¼å­˜å‚¨ï¼›jwt åŠ å¯†å¯†é’¥åˆ™ä¿å­˜åœ¨æœåŠ¡å™¨ä¸­ï¼Œviper ä»…å¯¹å…¶è·¯å¾„åšç®¡ç†ã€‚

```json
{
  "jwt": {
    "hmac": {
      "keyPath": "/Users/gsemir/.account/jwt/hmac.key"
    }
  },
  "email": {
    "smtp": {
      "host": "smtp.qq.com",
      "port": 465,
      "user": "845217811@qq.com",
      "password": "xxxx"
    }
  }
}
```

### 4.3 viper çš„ä½¿ç”¨

1. åˆ›å»ºåŠ è½½æ–¹æ³•ï¼ˆåœ¨ main.go ä»¥åŠæµ‹è¯•åˆå§‹åŒ–æ–¹æ³•ä¸­è°ƒç”¨ï¼‰ï¼Œè¯»å–é…ç½®æ–‡ä»¶

```go
// config/viper.go
package viper_config

import (
	"log"

	"github.com/spf13/viper"
)

func LoadViperConfig() {
  // 1. è®¾ç½®é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€æ–‡ä»¶åã€æ–‡ä»¶æ ¼å¼
	viper.AddConfigPath("$HOME/.account/")
	viper.SetConfigName("viper.config")
	viper.SetConfigType("json")
  // 2. ä½¿ç”¨ ReadInConfig è¯»å–é…ç½®
	err := viper.ReadInConfig()
	if err != nil {
		log.Fatalln(err)
	}
}
```

2. ä½¿ç”¨å¯†é’¥

viperæä¾›äº† `GetString(keyName)` æˆ– `GetInt(keyName)` ç­‰æ–¹æ³•è¯»å–å¯†é’¥å€¼

```go
// è¯»å– jwt å¯†é’¥
func getHmacSecret() ([]byte, error) {
	keyPath := viper.GetString("jwt.hmac.keyPath")
	return os.ReadFile(keyPath)
}

// å‘é€é‚®ä»¶
func newDialer() *gomail.Dialer {
	return gomail.NewDialer(
		viper.GetString("email.smtp.host"),
		viper.GetInt("email.smtp.port"),
		viper.GetString("email.smtp.user"),
		viper.GetString("email.smtp.password"),
	)
} 
```

## 5 å‘é€é‚®ä»¶

### 5.1 gomail

ä½¿ç”¨æµç¨‹ï¼š

1. `gomail.NewMessage()` æ„é€ é‚®ä»¶å†…å®¹
2. `gomail.NewDialer()` æ„é€ æ‹¨å·å™¨ï¼ˆé‚®ä»¶æœåŠ¡å™¨é…ç½®ï¼‰
3. `dialer.DialAndSend(message)` å‘é€é‚®ä»¶

```go
// internal/email/email.go
func newMessage(to, subject, body string) *gomail.Message {
	m := gomail.NewMessage()
	m.SetHeader("From", "845217811@qq.com")
	m.SetHeader("To", to)
	m.SetHeader("Subject", subject)
	m.SetBody("text/html", body)
	return m
}
func newDialer() *gomail.Dialer {
	return gomail.NewDialer(
		viper.GetString("email.smtp.host"),
		viper.GetInt("email.smtp.port"),
		viper.GetString("email.smtp.user"),
		viper.GetString("email.smtp.password"),
	)
}
func SendValidationCode(email, code string) error {
	m := newMessage(
		email,
		fmt.Sprintf("[%s] è®°è´¦éªŒè¯ç ", code),
		fmt.Sprintf(`
			ä½ æ­£åœ¨ç™»å½•æˆ–æ³¨å†Œè®°è´¦ç½‘ç«™ï¼Œä½ çš„éªŒè¯ç æ˜¯ %s ã€‚
			<br/>
			å¦‚æœä½ æ²¡æœ‰è¿›è¡Œç›¸å…³çš„æ“ä½œï¼Œè¯·ç›´æ¥å¿½ç•¥æœ¬é‚®ä»¶å³å¯`, code),
	)
	d := newDialer()
	return d.DialAndSend(m)
}
```

### 5.2 ç”ŸæˆçœŸéšæœºéªŒè¯ç 

- ä½¿ç”¨ `crypto/rand` åº“

æ³¨æ„æ•°å­—åˆ‡ç‰‡è½¬æ¢ä¸ºå­—ç¬¦ç¼–ç çš„é€»è¾‘

```go
// ä½¿ç”¨å†…ç½®åº“ crypto/rand ç”Ÿæˆéšæœºå››ä½éªŒè¯ç 
func generateDigits() (string, error) {
	len := 4
	// å¼€è¾Ÿä¸€ä¸ª 4 å­—èŠ‚çš„åˆ‡ç‰‡
	b := make([]byte, len)
	// ä½¿ç”¨ rand.Read æ–¹æ³•å¡«å……åˆ‡ç‰‡
	// æ­¤æ—¶ b çš„ç±»å‹ä¸º []uint8 å…¶ä¸­uint8çš„èŒƒå›´æ˜¯ 0-255
	_, err := rand.Read(b)
	if err != nil {
		return "", err
	}
	// å°†uint8æ•°å­—è½¬æ¢ä¸ºå­—ç¬¦
	digits := make([]byte, len)
	for i := range b {
		// æ•°å­—è½¬æ¢ä¸ºå­—ç¬¦ç¼–ç 
		// b[i]%10 å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ª 0-9 çš„æ•°å­—
		// '0' å¯¹åº”çš„ç¼–ç æ˜¯ 48 æ‰€ä»¥è¦åŠ  48 è½¬æ¢ä¸ºå­—ç¬¦ç¼–ç 
		digits[i] = b[i]%10 + 48
	}
	// [49, 50, 51, 52] è½¬ä¸ºå­—ç¬¦ä¸²å°±æ˜¯ "1234"
	return string(digits), nil
}
```

### 5.3 MailHog

- ä½¿ç”¨ MailHog ç®€åŒ–é‚®ä»¶æµ‹è¯•

  - å®‰è£…ï¼š `go install github.com/mailhog/MailHog@latest`

  - ä¼˜åŠ¿ï¼šæ— éœ€åœ¨æ‰“å¼€ç›®æ ‡é‚®ç®±å»çœ‹é‚®ä»¶æ˜¯å¦æ­£å¸¸å‘é€äº†

  - åœ¨æµ‹è¯•ä¸­ï¼Œéœ€è¦å°†è¯»å–åˆ°çš„é‚®ä»¶é…ç½® `email.smtp.host` å’Œ `email.smtp.port` ä½¿ç”¨ Viper è¦†ç›–

    ```go
    viper.Set("email.smtp.port", "1025")
    viper.Set("email.smtp.host", "localhost")
    ```

  - MailHog å‘½ä»¤å¯åŠ¨æœ¬åœ°é‚®ä»¶æœåŠ¡å™¨ï¼Œ 8025 å‰ç«¯ï¼Œ1025 åç«¯

  - æ­¤å¤–è¯¥æœåŠ¡å™¨è¿˜æä¾›äº† api ç”¨äºè¯»å–å…¨éƒ¨æ”¶åˆ°çš„é‚®ä»¶ï¼Œç”¨äºåœ¨æµ‹è¯•ä»£ç ä¸­è°ƒç”¨ è¿™æ ·è¿æ‰“å¼€ç½‘é¡µæ£€æŸ¥éƒ½ä¸ç”¨äº†ï¼ˆæœ¬é¡¹ç›®æ²¡ç”¨åˆ°ï¼‰

## 6 æ¥å£å¼€å‘

### 6.1 Controller æ¥å£å®šä¹‰ä¸ç”Ÿæˆ

#### Controller Interface

ä¸ºäº†æ–¹ä¾¿ç®¡ç† Controller çš„å¼€å‘ä¸å¼•å…¥ï¼Œç»Ÿä¸€è®¾è®¡ Controller æ¥å£ã€‚

- æ¥å£å…·æœ‰å¦‚ä¸‹ç‰¹å¾ï¼š

  - å®šä¹‰äº†ä¸€ç»„æ–¹æ³•çš„é›†åˆï¼ˆæ–¹æ³•ç­¾åï¼‰ï¼Œä½†ä¸åŒ…å«å…·ä½“çš„å®ç°ã€‚

  - æ¥å£æè¿°äº†å¯¹è±¡çš„è¡Œä¸ºï¼Œè€Œä¸å…³å¿ƒå¯¹è±¡çš„å…·ä½“ç±»å‹ã€‚

  - æ¥å£æ˜¯ä¸€ç§åŠ¨æ€ç±»å‹ï¼Œå¯ä»¥å®¹çº³ä»»ä½•å®ç°äº†è¯¥æ¥å£çš„ç±»å‹ã€‚

```go
package controller

import "github.com/gin-gonic/gin"

type Controller interface {
	Get(c *gin.Context)
	Create(c *gin.Context)
	Update(c *gin.Context)
	Find(c *gin.Context)
	Destory(c *gin.Context)
	GetPaged(c *gin.Context)
	RegisterRoutes(rg *gin.RouterGroup)
}
```

go ä¸­æ²¡æœ‰ç»§æ‰¿ä¸å®ç°çš„æ¦‚å¿µï¼Œåªè¦è¿™ä¸ªç»“æ„ä½“æœ‰æ¥å£è¦æ±‚çš„æ–¹æ³•å°±å¯ä»¥ä½œä¸ºè¿™ä¸ªæ¥å£çš„å®ç°

#### è‡ªåŠ¨ç”Ÿæˆ Controller ä»£ç 

æ¯ä¸ªæ¨¡å—çš„ ctrler ä¼šå­˜åœ¨å¤§é‡æ¨¡æ¿ä»£ç ï¼Œè¿™ç§äº‹æƒ…äº¤ç»™æœºå™¨åšå°±å¥½ 

> ä½¿ç”¨ impl åº“ï¼ŒåŸºäºController æ¥å£æ–‡ä»¶ï¼Œè‡ªåŠ¨ç¼–å†™å„æ¨¡å— controller ç»“æ„ä½“æ–¹æ³•ï¼š
>
> [josharian/impl: impl generates method stubs for implementing an interface. (github.com)](https://github.com/josharian/impl)
>
> å®‰è£…ï¼š `go install github.com/josharian/impl@latest`

è¯­æ³•å¦‚ä¸‹ï¼š

`impl 'ctrl *SessionController' account/internal/controller.Controller`

é…åˆ vscode æ’ä»¶ï¼Œ`ctrl+shift+p` æœç´¢ `go stubs` å‘½ä»¤

è¾“å…¥:  `ctrl *SessionController account/internal/controller.Controller` 

```go
package controller

import (...)

type ValidationCodeController struct{}

// å…¶ä¸­ (ctrl *ValidationCodeController) è¡¨ç¤ºè¯¥æ–¹æ³•çš„æ¥æ”¶è€…ä¸º ctrl
// å¯ä»¥ç†è§£ä¸ºè¯¥æ–¹æ³•æ˜¯ ValidationCodeController ç±»çš„å®ä¾‹æ–¹æ³•
func (ctrl *ValidationCodeController) Update(c *gin.Context) {
	panic("not implemented") // TODO: Implement
}

func (ctrl *ValidationCodeController) Get(c *gin.Context) {
	panic("not implemented") // TODO: Implement
}
// æ¯ä¸ª ctrl è‡ªå·±è´Ÿè´£åˆ†é…ä¸æ³¨å†Œè·¯ç”±
func (ctrl *ValidationCodeController) RegisterRoutes(rg *gin.RouterGroup) {
	v1 := rg.Group("/v1")
	v1.POST("validation_codes", ctrl.Create)
}
// ...
```

- æ³¨æ„è¾“å…¥æŒ‡ä»¤å‰ï¼Œé¼ æ ‡å…‰æ ‡åº”æ”¾ç½®åœ¨ä»£ç æ’å…¥çš„ä½ç½®

#### router æ³¨å†Œ

åœ¨è·¯ç”±åˆå§‹åŒ–é€»è¾‘ä¸­ï¼Œæ‰¹é‡æ³¨å†Œ ctrler 

- é¦–å…ˆæ‰¹é‡åˆå§‹åŒ–å„æ¨¡å—çš„ ctrler ç»“æ„ä½“ï¼Œè¯¥æ–¹æ³•è¿”å› Controller æ¥å£çš„åˆ‡ç‰‡

```go
// åœ¨ Go ä¸­ï¼Œæ¥å£æ˜¯ä¸€ç§æŠ½è±¡ç±»å‹ï¼Œä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ã€‚
// æ¥å£æœ¬èº«æ˜¯ä¸€ç»„æ–¹æ³•çš„é›†åˆï¼Œéœ€è¦ç»“æ„ä½“æˆ–å…¶ä»–è‡ªå®šä¹‰ç±»å‹æ¥å®ç°è¿™äº›æ–¹æ³•ï¼Œç„¶åé€šè¿‡è¿™äº›ç±»å‹æ¥åˆ›å»ºæ¥å£çš„å®ä¾‹ã€‚
// ä¹Ÿå°±æ˜¯è¯´ å¿…é¡»ä½¿ç”¨ç»“æ„ä½“æˆ–å…¶ä»–è‡ªå®šä¹‰ç±»å‹çš„å®ä¾‹å¯¹è±¡ ä½œä¸ºæ¥å£çš„å®ä¾‹ ä¸”å…¶ç±»å‹å¿…é¡»ä¸ºæŒ‡é’ˆ
func loadControllers() []controller.Controller {
	return []controller.Controller{
		&controller.SessionController{},
		&controller.MeController{},
		&controller.ItemController{},
		&controller.ValidationCodeController{},
		&controller.TagController{},
	}
}
```

- åœ¨routerçš„åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œå¾ªç¯åˆ‡ç‰‡ï¼Œè°ƒç”¨æ¯ä¸ªæ¨¡å—å®ä¾‹çš„æ³¨å†Œè·¯ç”±æ–¹æ³•

```go
func New() *gin.Engine {
	// æ³¨å†Œè·¯ç”±
	rg := r.Group("/api")
	for _, ctrl := range loadControllers() {
    // å®ä¾‹é€šè¿‡è°ƒç”¨è‡ªå·±çš„ RegisterRoutes æ¥æ³¨å†Œè·¯ç”±ï¼ˆéœ€è¦å°† r.Group è¿”å›å€¼ä¼ é€’è¿›å»ï¼‰
		ctrl.RegisterRoutes(rg)
	}
  // ...
	return r
}
```

### 6.2 æ¥å£å‡ºå…¥å‚ç±»å‹å£°æ˜

æ ¹æ®æ¥å£æ–‡æ¡£ï¼Œå£°æ˜æ¥å£å‡ºå…¥å‚ç±»å‹ï¼ŒæŠ½ç¦»ä¸º api åŒ…

é™¤äº†å£°æ˜å„å­—æ®µçš„æ•°æ®ç±»å‹ï¼Œè¿˜å¯ä»¥åœ¨åé¢ä½¿ç”¨åå¼•å·ä¸ºå­—æ®µæ·»åŠ æ ‡ç­¾ï¼Œå®ƒä»¬å‘Šè¯‰ Gin å¦‚ä½•ç»‘å®š HTTP è¯·æ±‚ä¸­çš„æ•°æ®åˆ°è¿™ä¸ªç»“æ„ä½“çš„å­—æ®µä¸Šï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«ä¸€äº›æ ¡éªŒé€»è¾‘

```go
package api

import (...)

type CreateItemRequest struct {
	Amount     int32     `json:"amount" binding:"required"`
	Kind       string    `json:"kind" binding:"required"`
	HappenedAt time.Time `json:"happened_at" binding:"required"`
	TagIds     []int32   `json:"tag_ids" binding:"required"`
}

type CreateItemResponse struct {
	Resource queries.Item
}

type GetPagedItemsRequest struct {
	Page           int32     `json:"page"`
	PageSize       int32     `json:"page_size"`
	HappenedAfter  time.Time `json:"happened_after"`
	HappenedBefore time.Time `json:"happened_before"`
}

type GetPagedItemsResponse struct {
	Resources []queries.Item
	Pager     Pager
}

type GetSummaryRequest struct {
	HappenedAfter  time.Time `form:"happened_after" binding:"required"`
	HappenedBefore time.Time `form:"happened_before" binding:"required"`
	Kind           string    `form:"kind" binding:"required,oneof=expenses in_come"`
	GroupBy        string    `form:"group_by" binding:"required,oneof=tag_id happened_at"`
}

type GetSummaryByTagIDResponse struct {
	Groups []SummaryGroupByTagID `json:"groups"`
	Total  int                   `json:"total"`
}
```

##### gin.H

åœ¨ Gin æ¡†æ¶ä¸­ï¼Œ`gin.H` æ˜¯ä¸€ä¸ªç±»å‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ˜ å°„ï¼ˆmapï¼‰ï¼Œç”¨äºè¡¨ç¤º HTTP å“åº”çš„é”®å€¼å¯¹ï¼ˆkey-valueï¼‰æ•°æ®ã€‚`gin.H` ç±»å‹å®é™…ä¸Šæ˜¯ä¸€ä¸ª `map[string]interface{}` çš„åˆ«åï¼Œå³ä¸€ä¸ªé”®ä¸ºå­—ç¬¦ä¸²ç±»å‹ã€å€¼ä¸ºä»»æ„ç±»å‹çš„æ˜ å°„ã€‚

`gin.H` ä¸»è¦ç”¨äºæ„å»ºå’Œå¤„ç† HTTP å“åº”çš„æ•°æ®ï¼Œé€šå¸¸ç”¨äºåœ¨è·¯ç”±å¤„ç†å‡½æ•°ä¸­è¿”å› JSON æ•°æ®æˆ–æ¸²æŸ“æ¨¡æ¿æ—¶ä¼ é€’æ•°æ®ã€‚å®ƒæä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥æ„å»ºåŒ…å«é”®å€¼å¯¹çš„æ•°æ®ç»“æ„ï¼Œè€Œä¸å¿…æ˜¾å¼åœ°å£°æ˜ç»“æ„ä½“ã€‚

### 6.3 Api è¯·æ±‚ä¸å“åº”

#### 6.3.1 è·å–è¯·æ±‚æ•°æ®

##### url æŸ¥è¯¢å‚æ•°

1. è·¯å¾„å‚æ•°

ä¾‹å¦‚ `api/v1/user/:id`ï¼Œä½¿ç”¨ `c.Params.GET("id")` æ¥è·å–

2. æŸ¥è¯¢å‚æ•°

ä¾‹å¦‚ `api/v1/user?id=1`ï¼Œä½¿ç”¨ `c.Request.URL.Query().Get("page")` æ¥è·å–

å¦‚æœæŸ¥è¯¢å‚æ•°è¿‡å¤šï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `c.BindQuery()` æ–¹æ³•å°†æŸ¥è¯¢å­—ç¬¦ä¸²ç»‘å®šä¸º query ç»“æ„ä½“

```go
var query api.GetSummaryRequest
if err := c.BindQuery(&query); err != nil {...}
```

æ³¨æ„ `api.GetSummaryRequest` ç»“æ„ä½“å­—æ®µç±»å‹çš„æ ‡ç­¾è¦ä½¿ç”¨ `form` è€Œä¸æ˜¯ `json`

##### è¯·æ±‚ä½“

ä½¿ç”¨ `c.ShouldBindJSON()` æ–¹æ³•å°† JSON è¯·æ±‚ä½“ç»‘å®šä¸º go ç»“æ„ä½“æ•°æ®

```go
var reqBody api.CreateTagRequest
if err := c.ShouldBindJSON(&reqBody); err != nil {
  c.String(422, "å‚æ•°é”™è¯¯")
  return
}
```

##### Bind

- `c.Bind()` ä¼šé€šè¿‡ `Content-Type` è¯·æ±‚å¤´åˆ¤æ–­å‚æ•°ç±»å‹ï¼Œä»è€Œç¡®å®šä½¿ç”¨ `BindQuery` æˆ–è€… `BindJSON` æ¥è§£æå‚æ•°ä¸º go çš„ç»“æ„ä½“
- Bind æ–¹æ³•åº•å±‚è°ƒç”¨çš„æ˜¯ `MustBindWith` æ–¹æ³•ï¼ŒæŠ¥é”™åä¼šç›´æ¥è¿”å›çŠ¶æ€ç  400 
  - `ShouldBindWith` æŠ¥é”™åä¸ä¼šè¿”å›çŠ¶æ€ç 
- æˆ‘ä»¬å¯ä»¥åœ¨ Bind æŠ¥é”™åï¼Œä½¿ç”¨` c.Writer.WriteString("å‚æ•°é”™è¯¯")` æ¥è¿½åŠ è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œï¼ˆå…¶ä¸­ Writer å°±ç›¸å½“äºå“åº”ä½“ï¼‰

#### 6.3.2 æ„é€ å“åº”ä½“

å½“ä»…éœ€è¿”å›ä¸€ä¸ªçŠ¶æ€ç æ—¶ï¼Œä½¿ç”¨ `c.Status(code)`ï¼Œä¾‹å¦‚ `c.Status(http.StatusUnauthorized)`

å½“éœ€è¦è¿”å›å­—ç¬¦ä¸²ä¿¡æ¯æ—¶ï¼Œä½¿ç”¨ `c.String(code, message)`ï¼Œä¾‹å¦‚ `c.String(422, "å‚æ•°é”™è¯¯")`

å½“éœ€è¦è¿”å› JSON æ•°æ®æ—¶ï¼Œä½¿ç”¨ `c.JSON(code, struct)`ï¼Œä¾‹å¦‚

```go
c.JSON(http.StatusOK, api.GetPagedTagsResponse{
  Resources: tags,
  Pager: api.Pager{
    Page:     params.Page,
    PageSize: params.PageSize,
    Total:    count,
  },
})
```

#### 6.3.3 é”™è¯¯å¤„ç†

ä¸»è¦æ˜¯åˆ©ç”¨ç»“æ„ä½“ç±»å‹çš„æ ‡ç­¾è¯­æ³•ï¼Œå¯¹è¯·æ±‚æ•°æ®è¿›è¡Œæ ¡éªŒ

ä¾‹å¦‚ï¼Œåœ¨å£°æ˜ api è¯·æ±‚ä¸å“åº”ç»“æ„ä½“ç±»å‹æ—¶ï¼Œåé¢çš„æ ‡ç­¾ `binding:"required"`è¡¨ç¤ºæ­¤é¡¹åœ¨ç»‘å®šç»“æ„ä½“æ—¶ä¸ºå¿…å¡«é¡¹ã€‚å¦‚æœè¯¥å‚æ•°æ²¡ä¼ ï¼Œä¼šè§¦å‘ BindQuery æ–¹æ³•æŠ¥é”™

è·å–æ ¡éªŒæŠ¥é”™ä¿¡æ¯ï¼Œé¦–å…ˆè¦æƒ³åŠæ³•æ‹¿åˆ°å‘ç”Ÿé”™è¯¯çš„å­—æ®µä»¥åŠé”™è¯¯ç±»å‹

##### è·å–é”™è¯¯å­—æ®µåŠç±»å‹

ç›®å‰ error çš„ç±»å‹åªæ˜¯ errorï¼Œæ— æ³•åŒºåˆ†å…¶å…·ä½“é”™è¯¯çš„ç±»å‹ 

é€šè¿‡ debugï¼Œçœ‹åˆ° error çš„ç±»å‹æ˜¯ä¸€ä¸ªåˆ‡ç‰‡ï¼Œå¹¶å‡ºç°äº† `validator.ValidationErrors` å­—æ ·

äºæ˜¯è®¿é—®è¿™ä¸ªåŒ…çš„å®˜ç½‘

> å®‰è£… `go get github.com/go-playground/validator/v10`
>
> å¼•å…¥ `import "github.com/go-playground/validator/v10"`

ValidationErrors ç±»å‹æ˜¯ FieldError ç±»å‹çš„åˆ‡ç‰‡ï¼Œç”¨äºéªŒè¯åçš„è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯

æ˜ç¡®äº†è¿™ä¸ªç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ switch case æ–­è¨€ error çš„ç±»å‹ï¼Œéå† error åˆ‡ç‰‡ï¼Œé€šè¿‡ FieldError æä¾›çš„æ–¹æ³• Tag() å’Œ Field() æ˜ç¡®é”™è¯¯ç§ç±»åŠæŠ¥é”™çš„å­—æ®µ

```go
func (ctrl *ItemController) GetSummary(c *gin.Context) {
  var query api.GetSummaryRequest
  if err := c.BindQuery(&query); err != nil {
    er := api.ErrorResponse{Errors: map[string][]string{}}
    switch e := err.(type) {
      case validator.ValidationErrors:
      for _, ve := range e {
        // é”™è¯¯æ ‡ç­¾
        tag := ve.Tag()
        // é”™è¯¯å­—æ®µ
        field := ve.Field()
        if er.Errors[field] == nil {
          er.Errors[field] = []string{}
        }
        // ç»™è¯¥fieldçš„æ•°ç»„è¿½åŠ ä¸€é¡¹
        er.Errors[field] = append(er.Errors[field], tag)
      }
      c.JSON(http.StatusUnprocessableEntity, r)
      default:
      c.Writer.WriteString("å‚æ•°é”™è¯¯")
    }
    return
  }
  //...
}
```

##### å†…ç½®æ ¡éªŒè§„åˆ™

é™¤äº† requiredï¼Œgin è¿˜å†…ç½®äº†å…¶ä»–æ ¡éªŒè§„åˆ™ï¼Œä½† gin æ–‡æ¡£ä¸­å¹¶æœªæåŠï¼Œè¯´æ˜æ­¤æ ¡éªŒå™¨å¹¶ä¸æ˜¯ gin åŸç”Ÿæä¾›çš„

é€šè¿‡æŸ¥çœ‹ BindQuery çš„æºç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ç»‘å®šç»“æ„ä½“æ—¶ï¼Œä¼šå°†æ•°æ®ç›´æ¥äº¤ç»™ `validate(Validator.ValidateStruct)` æ–¹æ³•ï¼Œè€Œæä¾›è¿™ä¸ªæ–¹æ³•çš„æ­£æ˜¯æˆ‘ä»¬åˆšæ‰å®‰è£…çš„ validator åŒ…

```go
func (queryBinding) Bind(req *http.Request, obj any) error {
  values := req.URL.Query()
  if err := mapForm(obj, values); err != nil {
    return err
  }
  return validate(obj)
}
```

gin åœ¨æŸä¸ªæ—¶åˆ»è°ƒç”¨ validator.New() åˆå§‹åŒ–äº† validator çš„å®ä¾‹

##### å…¶ä»–æ ¡éªŒå™¨

>  [validator package - github.com/go-playground/validator/v10 - Go Packages](https://pkg.go.dev/github.com/go-playground/validator/v10#section-readme)

é’ˆå¯¹ Kind å­—æ®µï¼Œåªå…è®¸æ˜¯æŸå‡ ä¸ªå­—ç¬¦ä¸²ï¼ˆ`expenses | in_come`ï¼‰çš„å…¶ä¸­ä¸€ç§ï¼Œé€‰æ‹© `oneof` æ£€éªŒè§„åˆ™

æ–‡æ¡£æ²¡æœ‰ç¤ºä¾‹å†™æ³•ï¼Œå¯ä»¥google `validator oneof tag usage`

åœ¨ api ç±»å‹å£°æ˜æ–‡ä»¶ä¸­ï¼Œå®šä¹‰ Kind å­—æ®µçš„ç±»å‹åŠæ ¡éªŒè§„åˆ™

```go
Kind  string  `form:"kind" binding:"required,oneof=expenses in_come"`
```

åç»­å¯ä»¥å°†è¿™ä¸ªé”™è¯¯å¤„ç†æ”¹ä¸ºä¸­é—´ä»¶

### 6.4 ç™»å½•ä¸ä¸­é—´ä»¶

#### 6.4.1 ç™»å½• api

åˆ›å»º Session Controller => å£°æ˜æ•°æ®åº“è¡¨ç±»å‹åŠ SQL è¯­å¥ => å£°æ˜æ¥å£æ•°æ®ç±»å‹ => å†™å•å…ƒæµ‹è¯• => å†™ç™»å½•é€»è¾‘

##### ç™»å½•é€»è¾‘

è·å–ä¸æ ¡éªŒè¯·æ±‚ä½“æ•°æ® => æŸ¥è¯¢éªŒè¯ç æ˜¯å¦æœ‰æ•ˆ => æŸ¥è¯¢ç”¨æˆ·ï¼ˆæ— åˆ™åˆ›å»ºï¼‰ => è¿”å› id åŠ jwt

##### jwt

> ç”Ÿæˆç¤ºä¾‹ï¼š[jwt package - github.com/golang-jwt/jwt/v5 - Go Packages](https://pkg.go.dev/github.com/golang-jwt/jwt/v5#example-New-Hmac)
>
> å®‰è£…: `go get -u github.com/golang-jwt/jwt/v5`

åˆ›å»º jwt_helper packageï¼Œå®šä¹‰ jwt è¾…åŠ©æ–¹æ³•ï¼Œåˆ†åˆ«ç”¨äº

- ç”ŸæˆåŠ å¯†ç”¨çš„å¯†é’¥ï¼ˆ64 ä½éšæœºæ•°ï¼‰

  - å°† HMAC å¯†é’¥ç”Ÿæˆåä¿å­˜åˆ°æœ¬åœ°ç¯å¢ƒå˜é‡ï¼Œé¿å…é‡å¤ç”Ÿæˆ
  - os.WriteFile ä¿å­˜åˆ°æœ¬åœ°ï¼Œviper ç¯å¢ƒå˜é‡ä¸­å­˜æ–‡ä»¶è·¯å¾„å³å¯ 
  - é€šè¿‡å‘½ä»¤è¡Œå·¥å…·ç”Ÿæˆ jwt å¯†é’¥å¹¶ä¿å­˜

  ```go
  func GenerateHmacSecret() ([]byte, error) {
  	key := make([]byte, 64)
  	_, err := io.ReadFull(rand.Reader, key)
  	if err != nil {
  		return nil, err
  	}
  	return key, nil
  }
  // cmd.go
  generateHmacSecretCmd := &cobra.Command{
  		Use: "generateHmacSecret",
  		Run: func(cmd *cobra.Command, args []string) {
  			// ç”Ÿæˆjwtå¯†é’¥å¹¶ä¿å­˜åˆ°æœ¬åœ°
  			bytes, _ := jwt_helper.GenerateHmacSecret()
  			keyPath := viper.GetString("jwt.hmac.keyPath")
        // os.WriteFile(è·¯å¾„, å­—èŠ‚æ•°æ®, æƒé™)
  			if err := os.WriteFile(keyPath, bytes, 0644); err != nil {
  				log.Fatalln(err)
  			}
  			fmt.Println("HMAC key has been saved in ", keyPath)
  		},
  	}
  ```

- æ ¹æ® viper å­˜å‚¨çš„è·¯å¾„è¯»å–å¯†é’¥

  ```go
  func getHmacSecret() ([]byte, error) {
  	keyPath := viper.GetString("jwt.hmac.keyPath")
  	return os.ReadFile(keyPath)
  }
  ```

- ä½¿ç”¨ jwt.Token æä¾›çš„ `SignedString` æ–¹æ³•ï¼ŒåŸºäºç”¨æˆ· id åŠ å¯†ç”Ÿæˆ jwt å­—ç¬¦ä¸²ï¼Œä½œä¸ºç™»å½•æ¥å£è¿”å›å€¼

  ```go
  func GenerateJWT(user_id int) (string, error) {
  	token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{
  		"user_id": user_id,
  	})
  	secret, err := getHmacSecret()
  	if err != nil {
  		return "", err
  	}
  	return token.SignedString(secret)
  }
  ```

- è§£æ jwt å­—ç¬¦ä¸²ï¼Œè¿”å› jwt.Token æŒ‡é’ˆ

  ```go
  func ParseJWT(jwtString string) (*jwt.Token, error) {
  	key, err := getHmacSecret()
  	if err != nil {
  		return nil, err
  	}
  	return jwt.Parse(jwtString, func(t *jwt.Token) (interface{}, error) {
  		return key, nil
  	})
  }
  ```

##### è·å–ç™»å½•ç”¨æˆ·

åœ¨è¯·æ±‚å¤´ä¸­è·å–æƒé™å­—æ®µï¼ˆjwtï¼‰ï¼Œè§£å¯†å‡º user_idï¼ŒæŸ¥æ‰¾è¿™ä¸ª id æ˜¯å¦æ˜¯æœ‰æ•ˆç”¨æˆ·

```go
func getMe(c *gin.Context) (queries.User, error) {
	var user queries.User
	auth := c.GetHeader("Authorization")
	if len(auth) < 8 {
		return user, fmt.Errorf("JWTä¸ºç©º")
	}
	// æˆªå– Bearer åçš„å­—ç¬¦
	jwtString := auth[7:]
	t, err := jwt_helper.ParseJWT(jwtString)
	if err != nil {
		return user, fmt.Errorf("æ— æ•ˆçš„jwt")
	}
	// å½“ä½ é€šè¿‡æŒ‡é’ˆè°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼ŒGo ä¼šè‡ªåŠ¨å¯¹æŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨ï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„æ–¹æ³•
	// æ‰€ä»¥è¿™é‡Œå¯ä»¥é€šè¿‡æŒ‡é’ˆç›´æ¥è°ƒç”¨ Claims æ–¹æ³•ï¼Œè·å– jwt å£°æ˜å†…å®¹
	claims, ok := t.Claims.(jwt.MapClaims)
	if !ok {
		return user, fmt.Errorf("æ— æ•ˆçš„jwt")
	}
	userID, ok := claims["user_id"].(float64)
	if !ok {
		return user, fmt.Errorf("æ— æ•ˆçš„jwt")
	}
	q := database.NewQuery()
	u, err := q.FindUser(c, int32(userID))
	if err != nil {
		return user, fmt.Errorf("æ— æ•ˆçš„jwt")
	}
	return u, nil
}
```

#### 6.4.2 ä¸­é—´ä»¶

##### é‰´æƒä¸­é—´ä»¶

gin æ¡†æ¶çš„ä¸­é—´ä»¶å¸¸è§ç»“æ„ï¼š

```go
func Middleware() gin.HandlerFunc {
  // è¿”å›ä¸€ä¸ªå‡½æ•°
  return func(c *gin.Context) {
    // ...
    // æš´éœ²åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œä½œä¸ºå…¨å±€å˜é‡
    c.Set("me", user)
    // ä¸­é—´ä»¶æ˜¯æŒ‰ç…§æ³¨å†Œçš„é¡ºåºæ‰§è¡Œçš„
    // ç§»äº¤æ§åˆ¶æƒï¼ˆä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–å¤„ç†å‡½æ•°ï¼‰
    c.Next()
  }
}
```

å¯ä»¥å°†è·å–ç™»å½•ç”¨æˆ·çš„é€»è¾‘æŠ½ç¦»å‡ºæ¥ï¼Œä½œä¸ºé‰´æƒä¸­é—´ä»¶ï¼Œç»Ÿä¸€å¤„ç†æƒé™æ ¡éªŒé€»è¾‘

```go
// middleware.go
func Me(whiteList []string) gin.HandlerFunc {
  return func(c *gin.Context) {
    path := c.Request.URL.Path
    // æ£€æµ‹ç™½åå•
    for _, s := range whiteList {
      if has := strings.HasPrefix(path, s); has {
        c.Next()
        return
      }
    }
    user, err := getMe(c)
    if err != nil {
      c.AbortWithStatusJSON(401, gin.H{
        "message": err.Error(),
      })
      return
    }
    // å°† me æ”¾åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œä½œä¸ºå…¨å±€å˜é‡
    c.Set("me", user)
    c.Next()
  }
}
```

##### é”™è¯¯å¤„ç†ä¸­é—´ä»¶

TODO

### 6.5 è®¨è®ºï¼šæ›´æ–°æ¥å£å…¥å‚è®¨è®º

> ä¸»è¦å›´ç»• Go ä¸­æ›´æ–°å­—æ®µä¼ å‚ç±»å‹è®¨è®º

å½“æŸå­—ç¬¦ä¸²ç±»å‹å­—æ®µä¸èƒ½ä¸ºç©ºï¼ˆ`NOT NULL`ï¼‰

æ›´æ–°æ—¶ï¼Œå¦‚æœä¸æƒ³æ›´æ–°è¯¥å­—æ®µï¼Œä½†ç”±äº api ä¸­å®šä¹‰äº†è¯¥å­—æ®µç±»å‹æ˜¯ stringï¼Œæ‰€ä»¥å³ä½¿ä¸ä¼ è¯¥å­—æ®µï¼Œ Go ä¹Ÿä¼šè‡ªåŠ¨å°†å…¶å˜æˆ  `""`ï¼Œ

å¦‚ä½•è®©ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸æ›´æ–°å‘¢ï¼šåœ¨ sql è¯­å¥ä¸­ä½¿ç”¨ `CASE WHEN THEN` ä½¿å…¶å¿½ç•¥ç©ºå­—ç¬¦ä¸²çš„æƒ…å†µ

##### æ–¹æ¡ˆä¸€ CASE WHEN THEN

æ–¹æ¡ˆä¸€å¯ä»¥è§£å†³å¿…å¡«å­—ç¬¦ä¸²ç±»å‹çš„é—®é¢˜ï¼Œæ³¨æ„æ ‡æ³¨å…¥å‚çš„ç±»å‹ï¼Œä¸ç„¶ sqlc ä¸è®¤è¯†

```sql
-- name: UpdateTag :one
UPDATE tags  
SET 
  user_id = @user_id,
  name = CASE WHEN @name::varchar = '' THEN name ELSE @name END,
  sign = CASE WHEN @sign::varchar = '' THEN sign ELSE @sign END,
  kind = CASE WHEN @kind::varchar = '' THEN kind ELSE @kind END
WHERE id = @id
RETURNING id, user_id, name, sign, kind, deleted_at, created_at, updated_at;
```

æ­¤æ—¶ï¼Œå¯¹äºæŸéç©ºå­—ç¬¦ä¸²å­—æ®µï¼Œåœ¨æ›´æ–°æ—¶ä¼  `""` è¡¨ç¤ºä¸æ›´æ–°è¯¥å­—æ®µï¼Œä¿ç•™åŸæ¥çš„å€¼

å½“æŸå­—ç¬¦ä¸²ç±»å‹å­—æ®µå¯ä»¥ä¸ºç©º

æ›´æ–°æ—¶ï¼Œä¼šå‡ºç°ä¸‰ç§æƒ…å†µï¼š`nil/""/"newStr"`ï¼Œæ­¤æ—¶ `nil` è¡¨ç¤ºä¸æ›´æ–°è¯¥å­—æ®µï¼Œ`""` è¡¨ç¤ºå°†å­—ç¬¦ä¸²ç½®ä¸º ""

å¯¹äºä»¥ä¸Šä¸¤ç§æƒ…å†µï¼ŒGo ä¼šè‡ªåŠ¨å°† `""` å’Œ `nil` éƒ½å˜ä¸º `""`ï¼ˆè¿˜æ˜¯å› ä¸º api ä¸­å£°æ˜äº† string ç±»å‹ï¼‰

å¦‚ä½•åœ¨ä¼  nil æ—¶è¡¨ç¤ºæ­¤é¡¹ä¸æ›´æ–°å‘¢ï¼š

##### æ–¹æ¡ˆäºŒ ä½¿ç”¨ NullString ç±»å‹

å½“å£°æ˜æ•°æ®åº“çš„ schema æ—¶ï¼Œå¦‚æœæŸå­—æ®µç±»å‹ä¸º `VARCHAR(100)` æ²¡æœ‰ `NOT NULL` å…³é”®å­—

é‚£ä¹ˆåœ¨ sqlc ç”Ÿæˆçš„ go ä»£ç ä¸­ï¼Œè¯¥å­—æ®µçš„ç±»å‹ä¼šè¢«æŒ‡å®šä¸º `sql.NullString` è€Œä¸æ˜¯ string

```go
type NullString struct {
  String string
  Valid bool // Valid is true if String is not NULL
}
```

`NullString` ç±»å‹æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œè¿™å°±ä¼šå¯¼è‡´è¯¥å­—æ®µä¼šåœ¨å“åº”ä½“ä¸­å˜æˆä¸€ä¸ªå¯¹è±¡è¿”å›ç»™å‰ç«¯ï¼Œè€Œä¸”åœ¨è¯·æ±‚ä½“ä¸­ä¹Ÿè¦å°†è¯¥å­—æ®µä½œä¸ºå¯¹è±¡ä¼ å›æ¥

è™½ç„¶ Go å¯ä»¥å€ŸåŠ©è¿™ä¸ªç»“æ„ä½“åŒºåˆ† `nil` å’Œ `""`ï¼Œä½†å®Œå…¨ä¸ç¬¦åˆæˆ‘ä»¬çš„å¼€å‘ä½¿ç”¨ä¹ æƒ¯

##### æ–¹æ¡ˆäºŒæ”¹è¿› é‡å†™ NullString ç±»å‹

é‡å†™ NullString ç±»å‹ä¸»è¦æ˜¯é‡å†™ç»“æ„ä½“çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ³•ï¼š`MarshalJSON` `UnmarshalJSON` ä»¥åŠæ•°æ®åº“è¯»å†™æ–¹æ³•ï¼š`Scan` å’Œ `Value`

```go
// config/my_null_string.go
package config

import (
	"bytes"
	"database/sql/driver"
	"encoding/json"
	"fmt"
)

type MyNullString struct {
	String string
	Valid  bool
}

func (s MyNullString) MarshalJSON() ([]byte, error) {
	if s.Valid {
		return []byte(`"` + s.String + `"`), nil
	}
	return []byte("null"), nil
}
func (s *MyNullString) UnmarshalJSON(data []byte) error {
	if bytes.Equal(data, []byte("null")) {
		s.Valid = false
		return nil
	}

	if err := json.Unmarshal(data, &s.String); err != nil {
		return fmt.Errorf("null: couldn't unmarshal JSON: %w", err)
	}

	s.Valid = true
	return nil
}

// ä»æ•°æ®åº“è¯»å€¼
func (s *MyNullString) Scan(value interface{}) error {
	if value == nil {
		s.Valid = false
		return nil
	}
	s.String, s.Valid = value.(string)
	return nil
}

// å‘æ•°æ®åº“å†™å€¼
func (s MyNullString) Value() (driver.Value, error) {
	if !s.Valid {
		return nil, nil
	}
	return s.String, nil
}

```

ç„¶åä¿®æ”¹ sqlc é…ç½®ï¼ŒæŒ‡å®š varchar ç±»å‹éç©ºæ—¶çš„ç±»å‹ä¸ºæˆ‘ä»¬é‡å†™çš„ `MyNullString` å³å¯

```yaml
- db_type: "pg_catalog.varchar"
  nullable: true
  go_type:
    import: "mangosteen/config"
    type: "MyNullString"
    pointer: false
    type: "string"
    pointer: true

```

é€šè¿‡é‡å†™ `NullString` ç±»å‹ï¼Œä½¿å¾— Go å’Œ sqlc èƒ½å¤Ÿè‡ªåŠ¨å¤„ç†å­—ç¬¦ä¸²ç±»å‹ä¸º `nil` çš„æƒ…å†µï¼Œä½†æ¯”è¾ƒéº»çƒ¦

##### æ–¹æ¡ˆä¸‰ ä½¿ç”¨ *string

å¯ä»¥åœ¨ sqlc çš„é…ç½®ä¸­å°† varchar ç±»å‹éç©ºçš„å­—æ®µæŒ‡å®šä¸ºå­—ç¬¦ä¸²çš„æŒ‡é’ˆç±»å‹ï¼ˆ`pointer: true`ï¼‰

åˆ©ç”¨æŒ‡é’ˆå¯ä»¥ä¸ºç©ºçš„ç‰¹ç‚¹ï¼Œå¦‚æœä¸ä¼ å€¼ï¼ˆæˆ–ä¼  nullï¼‰ï¼Œé‚£ä¹ˆ go ä¼šé»˜è®¤å˜æˆ nilï¼ˆnullï¼‰

å¦‚æœä¼ ç©ºå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆ Go ä¼šé»˜è®¤å˜æˆç©ºå­—ç¬¦ä¸²

éº»çƒ¦çš„ç‚¹åœ¨äºï¼Œå¦‚æœè¦åœ¨ Go ä»£ç ä¸­ä½¿ç”¨è¿™ä¸ªå­—æ®µçš„å€¼ï¼Œæ¯æ¬¡ä½¿ç”¨å‰éœ€è¿›è¡Œåˆ¤ç©ºå¤„ç†ï¼ˆå› ä¸ºæŒ‡é’ˆä¸ºç©ºæ—¶ï¼Œå–å€¼ä¼šæŠ¥é”™ï¼‰

##### æ–¹æ¡ˆå›› ä½¿ç”¨ null åº“

ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œä½¿ç”¨æ€è·¯ä¸æ–¹æ¡ˆä¸‰ä¸€è‡´

> [guregu/null: reasonable handling of nullable values (github.com)](https://github.com/guregu/null)

`go get gopkg.in/guregu/null.v4`

```yaml
- db_type: "pg_catalog.varchar"
  nullable: true
  go_type:
    import: "gopkg.in/guregu/null.v4"
    type: "String"
    pointer: false
```
ä¹‹åä¿®æ”¹ api ä¸­è¯¥å­—æ®µå‡ºå…¥å‚ç±»å‹ä¸º null.String

æ³¨æ„åœ¨ Go ä»£ç ä¸­ä½¿ç”¨æ—¶è¦ä»¥ç»“æ„ä½“æ¥è¯»ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½œä¸ºå­—ç¬¦ä¸²åˆ¤æ–­

ä¾‹å¦‚åœ¨æµ‹è¯•ä»£ç ä¸­ï¼š`assert.Equal(t, "xxx", j.Resource.X.String)`

## 7 æ–‡æ¡£ç”Ÿæˆ

ä½¿ç”¨ swaggo ç”ŸæˆAPIæ–‡æ¡£

> ä½¿ç”¨æ–‡æ¡£: [swag/README_zh-CN.md at master Â· swaggo/swag (github.com)](https://github.com/swaggo/swag/blob/master/README_zh-CN.md#å¿«é€Ÿå¼€å§‹)
>
> å®‰è£…ï¼š`go install github.com/swaggo/swag/cmd/swag@latest`

- å¸¸ç”¨å‘½ä»¤ï¼š
  - æ ¼å¼åŒ–ï¼š`swag fmt`
  - ç”Ÿæˆï¼š`swag init --parseDependency && go build . && ./account server`

- åœ¨ router ä¸­æ³¨å†Œ swagger è·¯ç”±åŠé…ç½®

  ```go
  import (
  	"account/internal/controller"
  	"account/internal/middleware"
  
  	"github.com/gin-gonic/gin"
  	swaggerFiles "github.com/swaggo/files"     // swagger embed files
  	ginSwagger "github.com/swaggo/gin-swagger" // gin-swagger middleware
  
  	
  	"account/docs"
  )
  
  func New() *gin.Engine {
  	// ...
    // ä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰‹åŠ¨ä¿®æ”¹æ–‡æ¡£ä¿¡æ¯
  	docs.SwaggerInfo.Version = "1.0"
    // æ–‡æ¡£è·¯ç”±åŠé…ç½®
  	r.GET("/swagger/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))
  }
  ```

### 7.1 é€šç”¨æ–‡æ¡£æ³¨é‡Š

é€šç”¨æ³¨é‡Šå†™åœ¨ main ä¸­

```go
// main.go
//	@title						è®°è´¦
//	@description				è®°è´¦åº”ç”¨æ¥å£æ–‡æ¡£
//
//	@contact.name				GSemir
//	@contact.url				http://gsemir0418.github.com/
//	@contact.email				gsemir0418@gmail.com
//
//	@host						localhost:8080
//	@BasePath					/
//
//	@securityDefinitions.apiKey	Bearer
//	@in							header
//	@name						Authorization
//
//	@externalDocs.description	OpenAPI
//	@externalDocs.url			https://swagger.io/resources/open-api/
func main() {}
```

è®¿é—® http://localhost:8080/swagger/index.html

### 7.2 æ¥å£æ–‡æ¡£æ³¨é‡Š

æ–‡æ¡£æ ¼å¼

æ³¨æ„è¦ç´§è´´æ§åˆ¶å™¨æ–¹æ³• ä¸­é—´ä¸è¦æœ‰ç©ºè¡Œ

ä¸”æ³¨é‡Šä¸­é—´ä¹Ÿä¸èƒ½æœ‰ç©ºè¡Œ è¦ä½¿ç”¨ç©ºçš„//ç›¸è¿

```go
// CreateTag
//
//	@Summary	åˆ›å»ºæ ‡ç­¾
//	@Accept		json
//	@Produce	json
//
//	@Security	Bearer
//
//	@Param		name		body		string				true	"é‡‘é¢ï¼ˆå•ä½ï¼šåˆ†ï¼‰"	example(é€šå‹¤)
//	@Param		kind		body		string	true	"ç±»å‹"		example(expenses)
//	@Param		sign	body		string			true	"ç¬¦å·"		example(ğŸ˜ˆ)
//
//	@Success	200			{object}	api.CreateTagResponse
//	@Failure	401			{string}	string	æ— æ•ˆçš„JWT
//	@Failure	422			{string}	string	å‚æ•°é”™è¯¯
//	@Router		/api/v1/tags [post]
func (ctrl *TagController) Create(c *gin.Context) {}
```

### 7.3 æ”¯æŒ JWT æµ‹è¯•

main.go

```go
//  @securityDefinitions.apiKey Bearer
//  @in             header
//  @name           Authorization
```

åœ¨éœ€è¦æƒé™çš„æ–‡æ¡£åŠ ä¸Šï¼šèƒ½è‡ªåŠ¨å¸¦ä¸Š Authorizition è¯·æ±‚å¤´

```go
//  @Security Bearer
```

ä¹‹åæˆ‘ä»¬åœ¨æµ‹è¯•å‰è·å–åˆ° validationCode ç„¶åè®¿é—® session æ¥å£ï¼Œå°†è¿”å›çš„ jwt ä¿å­˜åœ¨æ–‡æ¡£ä¸Šæ–¹ Authorize çš„ä½ç½®ï¼ˆåˆ«å¿˜ Bearer ï¼‰ 

éœ€è¦æƒé™çš„æ¥å£å°±ä¼šè‡ªåŠ¨æºå¸¦è¿™ä¸ªå…¨å±€ jwt æ¥è¯·æ±‚äº†

## 8 æ‰“åŒ…éƒ¨ç½²

TODO